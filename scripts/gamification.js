// scripts/gamification.js

import { authManager } from './auth-manager.js';
import { showToast } from './toast.js';

// ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏Å‡∏ì‡∏ë‡πå XP ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏¢ (‡πÉ‡∏ä‡πâ‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏á‡πà‡∏≤‡∏¢)
// ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÄ‡∏•‡πÄ‡∏ß‡∏•‡∏à‡∏∞‡∏°‡∏µ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç (Quest) ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô‡∏à‡∏∂‡∏á‡∏à‡∏∞‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÑ‡∏î‡πâ
export const XP_THRESHOLDS = [
    { level: 1, xp: 0, quest: null }, // No quest to reach level 1
    { level: 2, xp: 100, quest: { type: 'correct_streak', target: 10, desc: '‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ô 10 ‡∏Ç‡πâ‡∏≠' } },
    { level: 3, xp: 300, quest: { type: 'quizzes_completed', target: 5, desc: '‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 5 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á' } },
    { level: 4, xp: 600, quest: { type: 'perfect_scores', target: 1, desc: '‡∏ó‡∏≥‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏ï‡πá‡∏° 100% ‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á' } },
    { level: 5, xp: 1000, quest: { type: 'high_scores_80', target: 3, desc: '‡∏ó‡∏≥‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÑ‡∏î‡πâ 80% ‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ 3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á' } },
    { level: 6, xp: 1500, quest: { type: 'quizzes_completed', target: 15, desc: '‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 15 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á' } },
    { level: 7, xp: 2200, quest: { type: 'correct_streak', target: 20, desc: '‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ô 20 ‡∏Ç‡πâ‡∏≠' } },
    { level: 8, xp: 3000, quest: { type: 'astronomy_level', target: 5, desc: '‡πÑ‡∏õ‡πÉ‡∏´‡πâ‡∏ñ‡∏∂‡∏á‡πÄ‡∏•‡πÄ‡∏ß‡∏• 5 ‡πÉ‡∏ô‡∏™‡∏≤‡∏¢‡∏î‡∏≤‡∏£‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå' } },
    { level: 9, xp: 4000, quest: { type: 'earth_level', target: 5, desc: '‡πÑ‡∏õ‡πÉ‡∏´‡πâ‡∏ñ‡∏∂‡∏á‡πÄ‡∏•‡πÄ‡∏ß‡∏• 5 ‡πÉ‡∏ô‡∏™‡∏≤‡∏¢‡∏ß‡∏¥‡∏ó‡∏¢‡πå‡πÇ‡∏•‡∏Å' } },
    { level: 10, xp: 5500, quest: { type: 'quizzes_completed', target: 30, desc: '‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 30 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á' } },
    { level: 11, xp: 7500, quest: { type: 'high_scores_80', target: 10, desc: '‡∏ó‡∏≥‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÑ‡∏î‡πâ 80% ‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ 10 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á' } },
    { level: 12, xp: 10000, quest: { type: 'correct_streak', target: 30, desc: '‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ô 30 ‡∏Ç‡πâ‡∏≠' } },
    { level: 13, xp: 13000, quest: { type: 'quizzes_completed', target: 50, desc: '‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 50 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á' } },
    { level: 14, xp: 16500, quest: { type: 'perfect_scores', target: 5, desc: '‡∏ó‡∏≥‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏ï‡πá‡∏° 100% ‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ 5 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á' } },
    { level: 15, xp: 20500, quest: { type: 'astronomy_level', target: 10, desc: '‡πÑ‡∏õ‡πÉ‡∏´‡πâ‡∏ñ‡∏∂‡∏á‡πÄ‡∏•‡πÄ‡∏ß‡∏• 10 ‡πÉ‡∏ô‡∏™‡∏≤‡∏¢‡∏î‡∏≤‡∏£‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå' } },
    { level: 16, xp: 25000, quest: { type: 'earth_level', target: 10, desc: '‡πÑ‡∏õ‡πÉ‡∏´‡πâ‡∏ñ‡∏∂‡∏á‡πÄ‡∏•‡πÄ‡∏ß‡∏• 10 ‡πÉ‡∏ô‡∏™‡∏≤‡∏¢‡∏ß‡∏¥‡∏ó‡∏¢‡πå‡πÇ‡∏•‡∏Å' } },
    { level: 17, xp: 30000, quest: { type: 'high_scores_80', target: 20, desc: '‡∏ó‡∏≥‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÑ‡∏î‡πâ 80% ‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ 20 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á' } },
    { level: 18, xp: 36000, quest: { type: 'quizzes_completed', target: 100, desc: '‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö 100 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á' } },
    { level: 19, xp: 43000, quest: { type: 'correct_streak', target: 50, desc: '‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ô 50 ‡∏Ç‡πâ‡∏≠' } },
    { level: 20, xp: 50000, quest: { type: 'perfect_scores', target: 10, desc: '‡∏ó‡∏≥‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏ï‡πá‡∏° 100% ‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ 10 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á' } }
];

// ‡∏ä‡∏∑‡πà‡∏≠‡∏¢‡∏®‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏™‡∏≤‡∏¢ (Titles)
// ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏â‡∏≤‡∏¢‡∏≤‡∏ï‡∏≤‡∏°‡πÄ‡∏•‡πÄ‡∏ß‡∏•‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏™‡∏≤‡∏¢ (Overall, Physics, Earth Science)
// ‡πÇ‡∏î‡∏¢‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏â‡∏≤‡∏¢‡∏≤‡∏à‡∏≤‡∏Å Array ‡∏ô‡∏µ‡πâ‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÄ‡∏•‡πÄ‡∏ß‡∏• (Level 1 = Index 0)
// ‡∏´‡∏≤‡∏Å‡πÄ‡∏•‡πÄ‡∏ß‡∏•‡πÄ‡∏Å‡∏¥‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏â‡∏≤‡∏¢‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ ‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏â‡∏≤‡∏¢‡∏≤‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà
export const TRACK_TITLES = {
    overall: [
        "‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (Novice)", "‡∏ô‡∏±‡∏Å‡∏™‡∏≥‡∏£‡∏ß‡∏à (Explorer)", "‡∏ú‡∏π‡πâ‡∏£‡∏≠‡∏ö‡∏£‡∏π‡πâ (Scholar)", 
        "‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç (Expert)", "‡∏õ‡∏£‡∏≤‡∏ä‡∏ç‡πå (Sage)", "‡∏õ‡∏£‡∏°‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå (Master)", 
        "‡∏ï‡∏≥‡∏ô‡∏≤‡∏ô (Legend)", "‡∏ú‡∏π‡πâ‡∏û‡∏¥‡∏ó‡∏±‡∏Å‡∏©‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ (Guardian)", "‡∏°‡∏´‡∏≤‡∏õ‡∏£‡∏≤‡∏ä‡∏ç‡πå (Grand Sage)", "‡πÄ‡∏ó‡∏û‡πÄ‡∏à‡πâ‡∏≤‡πÅ‡∏´‡πà‡∏á‡∏õ‡∏±‡∏ç‡∏ç‡∏≤ (God of Wisdom)",
        "‡∏ú‡∏π‡πâ‡∏´‡∏¢‡∏±‡πà‡∏á‡∏£‡∏π‡πâ (The Seer)", "‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏£‡∏•‡∏∏ (The Enlightened)", "‡∏ú‡∏π‡πâ‡∏£‡∏≠‡∏ö‡∏£‡∏π‡πâ‡∏à‡∏±‡∏Å‡∏£‡∏ß‡∏≤‡∏• (Cosmic Scholar)",
        "‡∏ú‡∏π‡πâ‡∏û‡∏¥‡∏ó‡∏±‡∏Å‡∏©‡πå‡∏î‡∏ß‡∏á‡∏î‡∏≤‡∏ß (Stellar Guardian)", "‡∏õ‡∏£‡∏°‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡πÅ‡∏´‡πà‡∏á‡πÄ‡∏≠‡∏Å‡∏†‡∏û (Celestial Master)", "‡∏ú‡∏π‡πâ‡∏ñ‡∏≠‡∏î‡∏£‡∏´‡∏±‡∏™‡∏à‡∏±‡∏Å‡∏£‡∏ß‡∏≤‡∏• (Cosmic Decoder)",
        "‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ç‡∏ä‡∏≤‡∏Å‡∏≤‡∏£‡∏î‡∏ß‡∏á‡∏î‡∏≤‡∏ß (Star Commander)", "‡∏ï‡∏≥‡∏ô‡∏≤‡∏ô‡πÅ‡∏´‡πà‡∏á‡∏Å‡∏≤‡πÅ‡∏•‡πá‡∏Å‡∏ã‡∏µ (Galactic Legend)", "‡∏ú‡∏π‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏†‡∏û (Universe Crafter)", "‡∏´‡∏ô‡∏∂‡πà‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏à‡∏±‡∏Å‡∏£‡∏ß‡∏≤‡∏• (The One with the Cosmos)"
    ],
    astronomy: [
        "‡∏ô‡∏±‡∏Å‡∏î‡∏π‡∏î‡∏≤‡∏ß‡∏ù‡∏∂‡∏Å‡∏´‡∏±‡∏î", "‡∏ú‡∏π‡πâ‡∏´‡∏•‡∏á‡πÉ‡∏´‡∏•‡∏ó‡πâ‡∏≠‡∏á‡∏ü‡πâ‡∏≤", "‡∏ô‡∏±‡∏Å‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏î‡∏≤‡∏ß",
        "‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏∏‡∏£‡∏¥‡∏¢‡∏∞", "‡∏ô‡∏±‡∏Å‡∏î‡∏≤‡∏£‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå", "‡∏ú‡∏π‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ß‡∏á‡πÇ‡∏Ñ‡∏à‡∏£",
        "‡∏ú‡∏π‡πâ‡∏û‡∏¥‡∏ó‡∏±‡∏Å‡∏©‡πå‡∏´‡∏≠‡∏î‡∏π‡∏î‡∏≤‡∏ß", "‡∏à‡πâ‡∏≤‡∏ß‡πÅ‡∏´‡πà‡∏á‡πÄ‡∏ô‡∏ö‡∏¥‡∏ß‡∏•‡∏≤", "‡∏ú‡∏π‡πâ‡∏´‡∏¢‡∏±‡πà‡∏á‡∏£‡∏π‡πâ‡πÄ‡∏≠‡∏Å‡∏†‡∏û", "‡∏õ‡∏£‡∏°‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡∏î‡∏≤‡∏£‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå",
        "‡∏ú‡∏π‡πâ‡∏ó‡πà‡∏≠‡∏á‡∏Å‡∏≤‡∏•‡∏≠‡∏ß‡∏Å‡∏≤‡∏®", "‡∏ú‡∏π‡πâ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÅ‡∏£‡∏á‡πÇ‡∏ô‡πâ‡∏°‡∏ñ‡πà‡∏ß‡∏á", "‡∏ï‡∏≥‡∏ô‡∏≤‡∏ô‡πÅ‡∏´‡πà‡∏á‡∏ó‡∏≤‡∏á‡∏ä‡πâ‡∏≤‡∏á‡πÄ‡∏ú‡∏∑‡∏≠‡∏Å",
        "‡∏ú‡∏π‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏î‡∏≤‡∏ß‡∏§‡∏Å‡∏©‡πå", "‡∏à‡πâ‡∏≤‡∏ß‡πÅ‡∏´‡πà‡∏á‡∏´‡∏•‡∏∏‡∏°‡∏î‡∏≥", "‡∏ú‡∏π‡πâ‡πÑ‡∏Ç‡∏õ‡∏£‡∏¥‡∏®‡∏ô‡∏≤‡∏ö‡∏¥‡∏Å‡πÅ‡∏ö‡∏á",
        "‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ç‡∏ä‡∏≤‡∏Å‡∏≤‡∏£‡∏¢‡∏≤‡∏ô‡∏≠‡∏ß‡∏Å‡∏≤‡∏®", "‡πÄ‡∏ó‡∏û‡πÄ‡∏à‡πâ‡∏≤‡πÅ‡∏´‡πà‡∏á‡∏î‡∏ß‡∏á‡∏î‡∏≤‡∏ß", "‡∏ú‡∏π‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏à‡∏±‡∏Å‡∏£‡∏ß‡∏≤‡∏•", "‡∏´‡∏ô‡∏∂‡πà‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤"
    ],
    earth: [
        "‡∏ô‡∏±‡∏Å‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏´‡∏¥‡∏ô", "‡∏ú‡∏π‡πâ‡∏™‡∏ô‡πÉ‡∏à‡∏ò‡∏£‡∏ì‡∏µ", "‡∏ô‡∏±‡∏Å‡∏≠‡∏∏‡∏ï‡∏∏‡∏ô‡∏¥‡∏¢‡∏°‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏ù‡∏∂‡∏Å‡∏´‡∏±‡∏î",
        "‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà", "‡∏ô‡∏±‡∏Å‡∏ò‡∏£‡∏ì‡∏µ‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤", "‡∏ú‡∏π‡πâ‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå‡∏≠‡∏≤‡∏Å‡∏≤‡∏®",
        "‡∏ô‡∏±‡∏Å‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå", "‡∏ú‡∏π‡πâ‡∏´‡∏¢‡∏±‡πà‡∏á‡∏£‡∏π‡πâ‡πÉ‡∏ï‡πâ‡∏û‡∏¥‡∏†‡∏û", "‡∏à‡πâ‡∏≤‡∏ß‡πÅ‡∏´‡πà‡∏á‡∏°‡∏´‡∏≤‡∏™‡∏°‡∏∏‡∏ó‡∏£", "‡∏õ‡∏£‡∏°‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡∏ß‡∏¥‡∏ó‡∏¢‡πå‡πÇ‡∏•‡∏Å",
        "‡∏ú‡∏π‡πâ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÅ‡∏ú‡πà‡∏ô‡πÄ‡∏õ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏•‡∏Å", "‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ç‡∏ä‡∏≤‡∏Å‡∏≤‡∏£‡∏û‡∏≤‡∏¢‡∏∏", "‡∏ú‡∏π‡πâ‡∏û‡∏¥‡∏ó‡∏±‡∏Å‡∏©‡πå‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£",
        "‡∏ú‡∏π‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏†‡∏π‡πÄ‡∏Ç‡∏≤", "‡∏à‡πâ‡∏≤‡∏ß‡πÅ‡∏´‡πà‡∏á‡∏ß‡∏±‡∏è‡∏à‡∏±‡∏Å‡∏£", "‡∏ú‡∏π‡πâ‡πÑ‡∏Ç‡∏õ‡∏£‡∏¥‡∏®‡∏ô‡∏≤‡πÇ‡∏•‡∏Å‡∏•‡πâ‡∏≤‡∏ô‡∏õ‡∏µ",
        "‡∏ú‡∏π‡πâ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡∏ô‡πâ‡∏≥", "‡πÄ‡∏ó‡∏û‡πÄ‡∏à‡πâ‡∏≤‡πÅ‡∏´‡πà‡∏á‡∏ú‡∏∑‡∏ô‡∏î‡∏¥‡∏ô", "‡∏ú‡∏π‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏•‡∏Å", "‡∏à‡∏¥‡∏ï‡∏ß‡∏¥‡∏ç‡∏ç‡∏≤‡∏ì‡πÅ‡∏´‡πà‡∏á‡πÑ‡∏Å‡∏≠‡∏≤"
    ]
};

// DEPRECATED: Pet System Constants (Kept for backward compatibility)
export const PET_TYPES = {};
export const PET_LEVELS = [];

// ‡∏Ñ‡∏á‡πÑ‡∏ß‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ (Backward Compatibility) ‡πÅ‡∏•‡∏∞‡πÉ‡∏ä‡πâ‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á
export const LEVELS = XP_THRESHOLDS.map((t, i) => ({
    level: t.level,
    xp: t.xp,
    title: TRACK_TITLES.overall[i] || "Unknown"
}));

// NEW: Proficiency Groups (Shared definition)
export const PROFICIENCY_GROUPS = {
    'Astronomy': { 
        label: '‡∏î‡∏≤‡∏£‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå', 
        field: 'astronomyXP',
        track: 'astronomy',
        keywords: ['astronomy', '‡∏î‡∏≤‡∏£‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå', '‡πÄ‡∏≠‡∏Å‡∏†‡∏û', '‡∏Å‡∏≤‡πÅ‡∏•‡πá‡∏Å‡∏ã‡∏µ', '‡∏î‡∏≤‡∏ß‡∏§‡∏Å‡∏©‡πå', '‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏∏‡∏£‡∏¥‡∏¢‡∏∞', '‡∏î‡∏≤‡∏ß‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå', '‡∏ó‡∏£‡∏á‡∏Å‡∏•‡∏°‡∏ü‡πâ‡∏≤', '‡∏û‡∏¥‡∏Å‡∏±‡∏î', '‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÇ‡∏ó‡∏£‡∏ó‡∏£‡∏£‡∏®‡∏ô‡πå', '‡∏™‡πÄ‡∏õ‡∏Å‡∏ï‡∏£‡∏±‡∏°', '‡∏Å‡∏é‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ñ‡∏õ‡πÄ‡∏•‡∏≠‡∏£‡πå', '‡∏≠‡∏ß‡∏Å‡∏≤‡∏®', '‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡∏≠‡∏ß‡∏Å‡∏≤‡∏®', 'space'] 
    },
    'Geology': { 
        label: '‡∏ò‡∏£‡∏ì‡∏µ‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤', 
        field: 'geologyXP',
        track: 'earth',
        keywords: ['geology', '‡∏ò‡∏£‡∏ì‡∏µ', '‡∏´‡∏¥‡∏ô', '‡πÅ‡∏£‡πà', '‡∏ß‡∏±‡∏è‡∏à‡∏±‡∏Å‡∏£‡∏´‡∏¥‡∏ô', '‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏•‡∏Å', '‡πÅ‡∏ú‡πà‡∏ô‡πÄ‡∏õ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏•‡∏Å', '‡πÑ‡∏´‡∏ß‡∏™‡∏∞‡πÄ‡∏ó‡∏∑‡∏≠‡∏ô', '‡∏†‡∏π‡πÄ‡∏Ç‡∏≤‡πÑ‡∏ü', '‡∏ã‡∏≤‡∏Å‡∏î‡∏∂‡∏Å‡∏î‡∏≥‡∏ö‡∏£‡∏£‡∏û‡πå', '‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô‡∏´‡∏¥‡∏ô', '‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ò‡∏£‡∏ì‡∏µ', '‡∏î‡∏¥‡∏ô', '‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà'] 
    },
    'Meteorology': { 
        label: '‡∏≠‡∏∏‡∏ï‡∏∏‡∏ô‡∏¥‡∏¢‡∏°‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤', 
        field: 'meteorologyXP',
        track: 'earth',
        keywords: ['meteorology', '‡∏≠‡∏∏‡∏ï‡∏∏‡∏ô‡∏¥‡∏¢‡∏°‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤', '‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏Å‡∏≤‡∏®', '‡∏•‡∏°', '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏®', '‡πÄ‡∏°‡∏Ü', '‡∏´‡∏¢‡∏≤‡∏î‡∏ô‡πâ‡∏≥‡∏ü‡πâ‡∏≤', '‡∏û‡∏≤‡∏¢‡∏∏', '‡∏†‡∏π‡∏°‡∏¥‡∏≠‡∏≤‡∏Å‡∏≤‡∏®', '‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏Å‡∏≤‡∏®', '‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå', '‡∏™‡∏°‡∏î‡∏∏‡∏•‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô'] 
    },
    'Oceanography': {
        label: '‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå',
        field: 'oceanographyXP',
        track: 'earth',
        keywords: ['oceanography', '‡∏™‡∏°‡∏∏‡∏ó‡∏£', '‡∏ô‡πâ‡∏≥‡∏ó‡∏∞‡πÄ‡∏•', '‡∏°‡∏´‡∏≤‡∏™‡∏°‡∏∏‡∏ó‡∏£', '‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ñ‡πá‡∏°', '‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡∏ô‡πâ‡∏≥', '‡∏ô‡πâ‡∏≥‡∏Ç‡∏∂‡πâ‡∏ô‡∏ô‡πâ‡∏≥‡∏•‡∏á', '‡∏Ñ‡∏•‡∏∑‡πà‡∏ô', '‡∏ä‡∏≤‡∏¢‡∏ù‡∏±‡πà‡∏á', '‡∏ô‡∏¥‡πÄ‡∏ß‡∏®‡∏ó‡∏≤‡∏á‡∏ó‡∏∞‡πÄ‡∏•']
    }
};

// NEW: Theme definitions moved to a constant for reuse
const THEME_DEFINITIONS = {
    'forest': { main: '#059669', hover: '#047857', secondary: '#34d399', light_bg: '#d1fae5', dark_bg: 'rgba(6, 78, 59, 0.5)', ring: '#34d399' },
    'sunset': { main: '#ea580c', hover: '#c2410c', secondary: '#f59e0b', light_bg: '#ffedd5', dark_bg: 'rgba(124, 45, 18, 0.5)', ring: '#fbbf24' },
    'ocean': { main: '#0891b2', hover: '#0e7490', secondary: '#22d3ee', light_bg: '#cffafe', dark_bg: 'rgba(22, 78, 99, 0.5)', ring: '#67e8f9' },
    'berry': { main: '#db2777', hover: '#be185d', secondary: '#c026d3', light_bg: '#fce7f3', dark_bg: 'rgba(131, 24, 67, 0.5)', ring: '#e879f9' },
    'sakura': { main: '#f43f5e', hover: '#e11d48', secondary: '#fb7185', light_bg: '#ffe4e6', dark_bg: 'rgba(159, 18, 57, 0.5)', ring: '#fda4af' },
    'midnight': { 
        main: '#475569',        
        hover: '#334155',       
        secondary: '#64748b',   
        light_bg: '#f1f5f9',    
        dark_bg: 'rgba(30, 41, 59, 0.8)', 
        ring: '#94a3b8',        
        dark_text: '#94a3b8'    
    }
};

// ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏• (Badges)
export const BADGES = [
    { id: 'first_quiz', icon: 'üéØ', name: '‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô', desc: '‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', tier: 'bronze' },
    { id: 'perfect_score', icon: 'üèÜ', name: '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏ï‡πá‡∏°', desc: '‡πÑ‡∏î‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô 100% ‡πÉ‡∏ô‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏ì‡∏ë‡πå', tier: 'silver' },
    { id: 'perfect_scorer_3', icon: 'üèÖ', name: '‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡πÅ‡∏ö‡∏ö', desc: '‡πÑ‡∏î‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô 100% ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô 3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÉ‡∏ô‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏ì‡∏ë‡πå', tier: 'gold' },
    { id: 'perfect_scorer_5', icon: 'üéñÔ∏è', name: '‡πÄ‡∏à‡πâ‡∏≤‡πÅ‡∏´‡πà‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå', desc: '‡πÑ‡∏î‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô 100% ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô 5 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÉ‡∏ô‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏ì‡∏ë‡πå', tier: 'gold' },
    { id: 'high_scorer_3', icon: '‚≠ê', name: '‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°', desc: '‡πÑ‡∏î‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô 80% ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô 3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÉ‡∏ô‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏ì‡∏ë‡πå', tier: 'bronze' },
    { id: 'high_scorer_5', icon: 'üåü', name: '‡∏î‡∏≤‡∏ß‡πÄ‡∏î‡πà‡∏ô', desc: '‡πÑ‡∏î‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô 80% ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô 5 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÉ‡∏ô‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏ì‡∏ë‡πå', tier: 'silver' },
    { id: 'high_scorer_10', icon: 'üå†', name: '‡∏î‡∏≤‡∏ß‡∏à‡∏£‡∏±‡∏™‡∏ü‡πâ‡∏≤', desc: '‡πÑ‡∏î‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô 80% ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô 10 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÉ‡∏ô‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Å‡∏ì‡∏ë‡πå', tier: 'gold' },
    { id: 'marathon_runner', icon: 'üèÉ‚Äç‚ôÇÔ∏è', name: '‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡πà‡∏á‡∏°‡∏≤‡∏£‡∏≤‡∏ò‡∏≠‡∏ô', desc: '‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏°‡∏µ 50 ‡∏Ç‡πâ‡∏≠‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ‡∏à‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', tier: 'silver' },
    { id: 'streak_3', icon: 'üî•', name: '‡πÑ‡∏ü‡πÅ‡∏£‡∏á', desc: '‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á 3 ‡∏ß‡∏±‡∏ô', tier: 'silver' },
    { id: 'streak_7', icon: '‚ù§Ô∏è‚Äçüî•', name: '‡πÑ‡∏ü‡∏•‡∏∏‡∏Å‡πÇ‡∏ä‡∏ô', desc: '‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á 7 ‡∏ß‡∏±‡∏ô', tier: 'gold' },
    { id: 'streak_14', icon: 'üìÖ', name: '‡∏ß‡∏¥‡∏ô‡∏±‡∏¢‡∏î‡∏µ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°', desc: '‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á 14 ‡∏ß‡∏±‡∏ô', tier: 'gold' },
    { id: 'streak_30', icon: 'üóìÔ∏è', name: '‡∏ï‡∏≥‡∏ô‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏¢‡∏±‡∏ô', desc: '‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á 30 ‡∏ß‡∏±‡∏ô', tier: 'gold' },
    { id: 'streak_60', icon: 'üíé', name: '‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏û‡∏µ‡∏¢‡∏£‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏•‡∏¥‡∏®', desc: '‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á 60 ‡∏ß‡∏±‡∏ô', tier: 'gold' },
    { id: 'quiz_master_5', icon: 'üß†', name: '‡∏Ñ‡∏•‡∏±‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ', desc: '‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏£‡∏ö 5 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á', tier: 'silver' },
    { id: 'quiz_master_10', icon: 'üìö', name: '‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏°‡∏∏‡∏î‡πÄ‡∏î‡∏¥‡∏ô‡πÑ‡∏î‡πâ', desc: '‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏£‡∏ö 10 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á', tier: 'gold' },
    { id: 'quiz_master_25', icon: 'üéì', name: '‡∏ö‡∏±‡∏ì‡∏ë‡∏¥‡∏ï‡∏ô‡πâ‡∏≠‡∏¢', desc: '‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏£‡∏ö 25 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á', tier: 'gold' },
    { id: 'quiz_master_50', icon: 'üßô‚Äç‚ôÇÔ∏è', name: '‡∏à‡∏≠‡∏°‡πÄ‡∏ß‡∏ó‡∏¢‡πå‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ', desc: '‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏£‡∏ö 50 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á', tier: 'gold' },
    { id: 'quiz_master_100', icon: 'üëë', name: '‡πÄ‡∏ó‡∏û‡πÄ‡∏à‡πâ‡∏≤‡πÅ‡∏´‡πà‡∏á‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö', desc: '‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏£‡∏ö 100 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á', tier: 'gold' },
    { id: 'astro_lover', icon: 'üî≠', name: '‡∏£‡∏±‡∏Å‡∏î‡∏≤‡∏£‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå', desc: '‡∏ñ‡∏∂‡∏á‡πÄ‡∏•‡πÄ‡∏ß‡∏• 3 ‡πÉ‡∏ô‡∏™‡∏≤‡∏¢‡∏î‡∏≤‡∏£‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå', tier: 'silver' },
    { id: 'astro_expert', icon: 'üåå', name: '‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏î‡∏≤‡∏£‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå', desc: '‡∏ñ‡∏∂‡∏á‡πÄ‡∏•‡πÄ‡∏ß‡∏• 5 ‡πÉ‡∏ô‡∏™‡∏≤‡∏¢‡∏î‡∏≤‡∏£‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå', tier: 'gold' },
    { id: 'astro_master', icon: 'ü™ê', name: '‡∏õ‡∏£‡∏°‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡∏î‡∏≤‡∏£‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå', desc: '‡∏ñ‡∏∂‡∏á‡πÄ‡∏•‡πÄ‡∏ß‡∏• 10 ‡πÉ‡∏ô‡∏™‡∏≤‡∏¢‡∏î‡∏≤‡∏£‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå', tier: 'gold' },
    { id: 'earth_lover', icon: 'üåç', name: '‡∏£‡∏±‡∏Å‡∏©‡πå‡πÇ‡∏•‡∏Å', desc: '‡∏ñ‡∏∂‡∏á‡πÄ‡∏•‡πÄ‡∏ß‡∏• 3 ‡πÉ‡∏ô‡∏™‡∏≤‡∏¢‡∏ß‡∏¥‡∏ó‡∏¢‡πå‡πÇ‡∏•‡∏Å', tier: 'silver' },
    { id: 'earth_expert', icon: 'üåã', name: '‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏ß‡∏¥‡∏ó‡∏¢‡πå‡πÇ‡∏•‡∏Å', desc: '‡∏ñ‡∏∂‡∏á‡πÄ‡∏•‡πÄ‡∏ß‡∏• 5 ‡πÉ‡∏ô‡∏™‡∏≤‡∏¢‡∏ß‡∏¥‡∏ó‡∏¢‡πå‡πÇ‡∏•‡∏Å', tier: 'gold' },
    { id: 'earth_master', icon: 'üèîÔ∏è', name: '‡∏à‡πâ‡∏≤‡∏ß‡πÅ‡∏´‡πà‡∏á‡∏ò‡∏£‡∏ì‡∏µ', desc: '‡∏ñ‡∏∂‡∏á‡πÄ‡∏•‡πÄ‡∏ß‡∏• 10 ‡πÉ‡∏ô‡∏™‡∏≤‡∏¢‡∏ß‡∏¥‡∏ó‡∏¢‡πå‡πÇ‡∏•‡∏Å', tier: 'gold' },
    { id: 'xp_5k', icon: 'üíµ', name: '‡πÄ‡∏®‡∏£‡∏©‡∏ê‡∏µ‡∏ù‡∏∂‡∏Å‡∏´‡∏±‡∏î', desc: '‡∏°‡∏µ XP ‡∏£‡∏ß‡∏°‡∏™‡∏∞‡∏™‡∏°‡∏Ñ‡∏£‡∏ö 5,000', tier: 'silver' },
    { id: 'xp_10k', icon: 'üí∞', name: '‡∏ú‡∏π‡πâ‡∏™‡∏±‡πà‡∏á‡∏™‡∏°‡∏õ‡∏£‡∏∞‡∏™‡∏ö‡∏Å‡∏≤‡∏£‡∏ì‡πå', desc: '‡∏°‡∏µ XP ‡∏£‡∏ß‡∏°‡∏™‡∏∞‡∏™‡∏°‡∏Ñ‡∏£‡∏ö 10,000', tier: 'gold' },
    { id: 'dual_expert', icon: '‚öñÔ∏è', name: '‡∏ú‡∏π‡πâ‡∏£‡∏≠‡∏ö‡∏£‡∏π‡πâ‡∏™‡∏≠‡∏á‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå', desc: '‡∏ñ‡∏∂‡∏á‡πÄ‡∏•‡πÄ‡∏ß‡∏• 5 ‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≤‡∏¢‡∏î‡∏≤‡∏£‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡∏ó‡∏¢‡πå‡πÇ‡∏•‡∏Å', tier: 'gold' },
    { id: 'shop_spender', icon: 'üõçÔ∏è', name: '‡∏ô‡∏±‡∏Å‡∏ä‡πâ‡∏≠‡∏õ', desc: '‡∏ã‡∏∑‡πâ‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ñ‡∏£‡∏ö 5 ‡∏ä‡∏¥‡πâ‡∏ô', tier: 'silver' },
    { id: 'weekend_learner_3', icon: 'üèñÔ∏è', name: '‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î', desc: '‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏™‡∏∏‡∏î‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏Ñ‡∏£‡∏ö 3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á', tier: 'bronze' },
    { id: 'weekend_learner_5', icon: 'üèïÔ∏è', name: '‡∏Ç‡∏¢‡∏±‡∏ô‡∏™‡∏∏‡∏î‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå', desc: '‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏™‡∏∏‡∏î‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏Ñ‡∏£‡∏ö 5 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á', tier: 'silver' },
    { id: 'weekend_learner_10', icon: 'üèùÔ∏è', name: '‡πÄ‡∏à‡πâ‡∏≤‡πÅ‡∏´‡πà‡∏á‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î', desc: '‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏™‡∏∏‡∏î‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏Ñ‡∏£‡∏ö 10 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á', tier: 'gold' },
    { id: 'weekend_learner_15', icon: 'üéâ', name: '‡∏ï‡∏≥‡∏ô‡∏≤‡∏ô‡∏™‡∏∏‡∏î‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå', desc: '‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏™‡∏∏‡∏î‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏Ñ‡∏£‡∏ö 15 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á', tier: 'gold' },
    // Proficiency Badges
    { id: 'astronomy_expert', icon: 'üî≠', name: '‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏î‡∏≤‡∏£‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå', desc: '‡∏°‡∏µ XP ‡∏™‡∏≤‡∏¢‡∏î‡∏≤‡∏£‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏Ñ‡∏£‡∏ö 1,000', tier: 'silver' },
    { id: 'geology_expert', icon: 'ü™®', name: '‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏ò‡∏£‡∏ì‡∏µ', desc: '‡∏°‡∏µ XP ‡∏™‡∏≤‡∏¢‡∏ò‡∏£‡∏ì‡∏µ‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Ñ‡∏£‡∏ö 1,000', tier: 'silver' },
    { id: 'meteorology_expert', icon: '‚õàÔ∏è', name: '‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏≠‡∏∏‡∏ï‡∏∏‡∏Ø', desc: '‡∏°‡∏µ XP ‡∏™‡∏≤‡∏¢‡∏≠‡∏∏‡∏ï‡∏∏‡∏ô‡∏¥‡∏¢‡∏°‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Ñ‡∏£‡∏ö 1,000', tier: 'silver' },
    { id: 'oceanography_expert', icon: 'üåä', name: '‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏Ø', desc: '‡∏°‡∏µ XP ‡∏™‡∏≤‡∏¢‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏Ñ‡∏£‡∏ö 1,000', tier: 'silver' }
];

// ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô (Daily Quests)
export const DAILY_QUESTS = [
    { id: 'quiz_1', desc: '‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡∏à‡∏ö 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á', target: 1, type: 'quiz_complete', xp: 50 },
    { id: 'quiz_2', desc: '‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡∏à‡∏ö 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á', target: 2, type: 'quiz_complete', xp: 100 },
    { id: 'correct_10', desc: '‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ 10 ‡∏Ç‡πâ‡∏≠', target: 10, type: 'correct_answers', xp: 80 },
    { id: 'correct_15', desc: '‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ 15 ‡∏Ç‡πâ‡∏≠', target: 15, type: 'correct_answers', xp: 120 },
    { id: 'astro_5', desc: '‡∏ó‡∏≥‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏î‡∏≤‡∏£‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå 5 ‡∏Ç‡πâ‡∏≠', target: 5, type: 'questions_category', category: 'Astronomy', xp: 100 },
    { id: 'earth_5', desc: '‡∏ó‡∏≥‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏ß‡∏¥‡∏ó‡∏¢‡πå‡πÇ‡∏•‡∏Å 5 ‡∏Ç‡πâ‡∏≠', target: 5, type: 'questions_category', category: 'Earth', xp: 100 },
    { id: 'score_80', desc: '‡∏ó‡∏≥‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ 80% ‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á', target: 1, type: 'high_score', threshold: 80, xp: 150 },
    { id: 'score_100', desc: '‡∏ó‡∏≥‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏ï‡πá‡∏° (100%) 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á', target: 1, type: 'high_score', threshold: 100, xp: 300 },
    // NEW QUEST TYPES
    { id: 'theory_10', desc: '‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏§‡∏©‡∏é‡∏µ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å 10 ‡∏Ç‡πâ‡∏≠', target: 10, type: 'correct_answers_type', questionType: 'theory', xp: 120 },
    { id: 'astro_quiz_1', desc: '‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏î‡∏≤‡∏£‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á', target: 1, type: 'quiz_category', category: 'Astronomy', xp: 80 },
    { id: 'earth_quiz_1', desc: '‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏ß‡∏¥‡∏ó‡∏¢‡πå‡πÇ‡∏•‡∏Å 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á', target: 1, type: 'quiz_category', category: 'Earth', xp: 80 },
    { id: 'review_quiz_1', desc: '‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á', target: 1, type: 'quiz_category', category: 'Review', xp: 80 },
    // More quests for variety
    { id: 'quiz_5', desc: '‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡∏à‡∏ö 5 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á', target: 5, type: 'quiz_complete', xp: 250 },
    { id: 'correct_50', desc: '‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ 50 ‡∏Ç‡πâ‡∏≠', target: 50, type: 'correct_answers', xp: 400 },
    { id: 'earth_10', desc: '‡∏ó‡∏≥‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏ß‡∏¥‡∏ó‡∏¢‡πå‡πÇ‡∏•‡∏Å 10 ‡∏Ç‡πâ‡∏≠', target: 10, type: 'questions_category', category: 'Earth', xp: 150 }
];

// ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (Achievements)
export const ACHIEVEMENTS = [
    { id: 'level_5', title: '‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏î‡∏µ‡πÄ‡∏î‡πà‡∏ô', desc: '‡πÄ‡∏•‡πÄ‡∏ß‡∏•‡∏ñ‡∏∂‡∏á 5', icon: '‚≠ê', target: 5, type: 'level', rewardTitle: '‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏î‡∏µ‡πÄ‡∏î‡πà‡∏ô' },
    { id: 'level_10', title: '‡∏™‡∏∏‡∏î‡∏¢‡∏≠‡∏î‡∏õ‡∏±‡∏ç‡∏ç‡∏≤', desc: '‡πÄ‡∏•‡πÄ‡∏ß‡∏•‡∏ñ‡∏∂‡∏á 10', icon: 'üëë', target: 10, type: 'level', rewardTitle: '‡∏™‡∏∏‡∏î‡∏¢‡∏≠‡∏î‡∏õ‡∏±‡∏ç‡∏ç‡∏≤' },
    { id: 'level_15', title: '‡∏ú‡∏π‡πâ‡∏ó‡∏£‡∏á‡∏†‡∏π‡∏°‡∏¥', desc: '‡πÄ‡∏•‡πÄ‡∏ß‡∏•‡∏ñ‡∏∂‡∏á 15', icon: 'üîÆ', target: 15, type: 'level', rewardTitle: '‡∏ú‡∏π‡πâ‡∏ó‡∏£‡∏á‡∏†‡∏π‡∏°‡∏¥' },
    { id: 'level_20', title: '‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡πå', desc: '‡πÄ‡∏•‡πÄ‡∏ß‡∏•‡∏ñ‡∏∂‡∏á 20', icon: 'üåü', target: 20, type: 'level', rewardTitle: '‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡πå' },
    { id: 'correct_100', title: '‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏î‡∏±‡πà‡∏á‡∏à‡∏±‡∏ö‡∏ß‡∏≤‡∏á', desc: '‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏£‡∏ö 100 ‡∏Ç‡πâ‡∏≠', icon: 'üéØ', target: 100, type: 'total_correct', rewardTitle: '‡∏ú‡∏π‡πâ‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥' },
    { id: 'correct_500', title: '‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏°‡∏≠‡∏á‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà', desc: '‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏£‡∏ö 500 ‡∏Ç‡πâ‡∏≠', icon: 'üß†', target: 500, type: 'total_correct', rewardTitle: '‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏°‡∏≠‡∏á' },
    { id: 'correct_1000', title: '‡∏™‡∏≤‡∏£‡∏≤‡∏ô‡∏∏‡∏Å‡∏£‡∏°‡πÄ‡∏î‡∏¥‡∏ô‡πÑ‡∏î‡πâ', desc: '‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏£‡∏ö 1,000 ‡∏Ç‡πâ‡∏≠', icon: 'üìñ', target: 1000, type: 'total_correct', rewardTitle: '‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞' },
    { id: 'correct_2000', title: '‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡πå', desc: '‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏£‡∏ö 2,000 ‡∏Ç‡πâ‡∏≠', icon: 'ü§ñ', target: 2000, type: 'total_correct', rewardTitle: '‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡πå' },
    { id: 'quiz_50', title: '‡∏ú‡∏π‡πâ‡πÄ‡∏à‡∏ô‡∏à‡∏±‡∏î‡∏™‡∏ô‡∏≤‡∏°‡∏™‡∏≠‡∏ö', desc: '‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏£‡∏ö 50 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á', icon: 'üìù', target: 50, type: 'total_quizzes', rewardTitle: '‡πÄ‡∏ã‡∏µ‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö' },
    { id: 'quiz_100', title: '‡∏ú‡∏π‡πâ‡∏û‡∏¥‡∏ä‡∏¥‡∏ï‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö', desc: '‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏£‡∏ö 100 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á', icon: 'üíØ', target: 100, type: 'total_quizzes', rewardTitle: '‡∏ú‡∏π‡πâ‡∏û‡∏¥‡∏ä‡∏¥‡∏ï' },
    { id: 'quiz_200', title: '‡∏ï‡∏≥‡∏ô‡∏≤‡∏ô‡πÄ‡∏î‡∏¥‡∏ô‡∏î‡∏¥‡∏ô', desc: '‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏£‡∏ö 200 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á', icon: 'üèõÔ∏è', target: 200, type: 'total_quizzes', rewardTitle: '‡∏ï‡∏≥‡∏ô‡∏≤‡∏ô‡πÄ‡∏î‡∏¥‡∏ô‡∏î‡∏¥‡∏ô' },
    { id: 'high_achiever_5', title: '‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡πÇ‡∏î‡∏î‡πÄ‡∏î‡πà‡∏ô', desc: '‡∏ó‡∏≥‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÑ‡∏î‡πâ 80% ‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ 5 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á', icon: 'üåü', target: 5, type: 'high_scores_80', rewardTitle: '‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏ú‡∏•‡∏á‡∏≤‡∏ô‡πÇ‡∏î‡∏î‡πÄ‡∏î‡πà‡∏ô' },
    { id: 'perfectionist_3', title: '‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡πÅ‡∏ö‡∏ö', desc: '‡∏ó‡∏≥‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏ï‡πá‡∏° 100% ‡πÑ‡∏î‡πâ 3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á', icon: 'üèÖ', target: 3, type: 'perfect_scores', rewardTitle: '‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡πÅ‡∏ö‡∏ö' },
    { id: 'collector_5', title: '‡∏ô‡∏±‡∏Å‡∏™‡∏∞‡∏™‡∏°‡∏°‡∏∑‡∏≠‡πÉ‡∏´‡∏°‡πà', desc: '‡∏°‡∏µ‡πÑ‡∏≠‡πÄ‡∏ó‡∏°‡πÉ‡∏ô‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏≠‡∏á 5 ‡∏ä‡∏¥‡πâ‡∏ô', icon: 'üéí', target: 5, type: 'total_items', rewardTitle: '‡∏ô‡∏±‡∏Å‡∏™‡∏∞‡∏™‡∏°' },
    { id: 'collector_10', title: '‡∏ô‡∏±‡∏Å‡∏™‡∏∞‡∏™‡∏°‡∏ï‡∏±‡∏ß‡∏¢‡∏á', desc: '‡∏°‡∏µ‡πÑ‡∏≠‡πÄ‡∏ó‡∏°‡πÉ‡∏ô‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏≠‡∏á 10 ‡∏ä‡∏¥‡πâ‡∏ô', icon: 'üì¶', target: 10, type: 'total_items', rewardTitle: '‡∏Ñ‡∏•‡∏±‡∏á‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥' },
    { id: 'avatar_5', title: '‡πÅ‡∏ü‡∏ä‡∏±‡πà‡∏ô‡∏ô‡∏¥‡∏™‡∏ï‡πâ‡∏≤', desc: '‡∏°‡∏µ‡∏≠‡∏ß‡∏ï‡∏≤‡∏£‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏≠‡∏á 5 ‡πÅ‡∏ö‡∏ö', icon: 'üé≠', target: 5, type: 'total_avatars', rewardTitle: '‡πÅ‡∏ü‡∏ä‡∏±‡πà‡∏ô‡∏ô‡∏¥‡∏™‡∏ï‡πâ‡∏≤' }
];

// ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ (Shop Items)
export const SHOP_ITEMS = [
    // 50 XP
    { id: 'item_cut_1', type: 'consumable', name: '‡∏ï‡∏±‡∏î‡∏ä‡πâ‡∏≠‡∏¢‡∏™‡πå (25%)', icon: 'üî™', cost: 50, value: 'cut_1', desc: '‡∏ï‡∏±‡∏î‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏î‡∏≠‡∏≠‡∏Å 1 ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å' },
    { id: 'item_range_hint', type: 'consumable', name: '‡∏™‡πÇ‡∏Ñ‡∏õ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö', icon: 'üéØ', cost: 50, value: 'range_hint', desc: '‡∏ö‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç)' },
    { id: 'item_tolerance', type: 'consumable', name: '‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏õ‡πâ‡∏≤', icon: '‚≠ï', cost: 50, value: 'tolerance', desc: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏•‡∏≤‡∏î‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ +/- 20% (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç)' },
    
    // 100 XP
    { id: 'item_5050', type: 'consumable', name: '‡∏ï‡∏±‡∏ß‡∏ä‡πà‡∏ß‡∏¢ 50/50', icon: '‚úÇÔ∏è', cost: 100, value: '5050', desc: '‡∏ï‡∏±‡∏î‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏î‡∏≠‡∏≠‡∏Å 2 ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å' },
    
    // 120 XP
    { id: 'item_streak_freeze', type: 'consumable', name: 'Streak Freeze', icon: 'üßä', cost: 120, value: 'streak_freeze', desc: '‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Streak ‡∏´‡∏≤‡∏¢‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô 1 ‡∏ß‡∏±‡∏ô (‡πÉ‡∏ä‡πâ‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥)' },

    // 150 XP
    { id: 'avatar_earth', type: 'avatar', name: '‡πÇ‡∏•‡∏Å', icon: 'üåç', cost: 150, value: 'üåç', desc: '‡∏≠‡∏ß‡∏ï‡∏≤‡∏£‡πÇ‡∏•‡∏Å‡∏™‡∏µ‡∏Ñ‡∏£‡∏≤‡∏°' },
    { id: 'avatar_newmoon', type: 'avatar', name: '‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå‡∏î‡∏±‡∏ö', icon: 'üåë', cost: 150, value: 'üåë', desc: '‡∏≠‡∏ß‡∏ï‡∏≤‡∏£‡∏î‡∏ß‡∏á‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå‡πÉ‡∏ô‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏°‡∏∑‡∏î' },
    { id: 'avatar_star', type: 'avatar', name: '‡∏î‡∏≤‡∏ß', icon: '‚≠ê', cost: 150, value: '‚≠ê', desc: '‡∏≠‡∏ß‡∏ï‡∏≤‡∏£‡∏î‡∏ß‡∏á‡∏î‡∏≤‡∏ß‡πÄ‡∏õ‡∏•‡πà‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏¢' },
    { id: 'avatar_frog', type: 'avatar', name: '‡∏Å‡∏ö', icon: 'üê∏', cost: 150, value: 'üê∏', desc: '‡∏≠‡∏ß‡∏ï‡∏≤‡∏£‡∏Å‡∏ö' },
    { id: 'avatar_hamster', type: 'avatar', name: '‡πÅ‡∏Æ‡∏°‡∏™‡πÄ‡∏ï‡∏≠‡∏£‡πå', icon: 'üêπ', cost: 150, value: 'üêπ', desc: '‡∏≠‡∏ß‡∏ï‡∏≤‡∏£‡∏´‡∏ô‡∏π‡πÅ‡∏Æ‡∏°‡∏™‡πÄ‡∏ï‡∏≠‡∏£‡πå' },
    { id: 'avatar_bunny', type: 'avatar', name: '‡∏Å‡∏£‡∏∞‡∏ï‡πà‡∏≤‡∏¢', icon: 'üê∞', cost: 150, value: 'üê∞', desc: '‡∏≠‡∏ß‡∏ï‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ï‡πà‡∏≤‡∏¢‡∏ô‡πâ‡∏≠‡∏¢' },
    { id: 'item_time_freeze', type: 'consumable', name: '‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏ß‡∏•‡∏≤', icon: '‚ùÑÔ∏è', cost: 150, value: 'time_freeze', desc: '‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ' },
    
    // 200 XP
    { id: 'avatar_saturn', type: 'avatar', name: '‡∏î‡∏≤‡∏ß‡πÄ‡∏™‡∏≤‡∏£‡πå', icon: 'ü™ê', cost: 200, value: 'ü™ê', desc: '‡∏≠‡∏ß‡∏ï‡∏≤‡∏£‡∏î‡∏≤‡∏ß‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏°‡∏µ‡∏ß‡∏á‡πÅ‡∏´‡∏ß‡∏ô' },
    { id: 'avatar_comet', type: 'avatar', name: '‡∏î‡∏≤‡∏ß‡∏´‡∏≤‡∏á', icon: '‚òÑÔ∏è', cost: 200, value: '‚òÑÔ∏è', desc: '‡∏≠‡∏ß‡∏ï‡∏≤‡∏£‡∏î‡∏≤‡∏ß‡∏´‡∏≤‡∏á‡∏ú‡∏π‡πâ‡∏°‡∏≤‡πÄ‡∏¢‡∏∑‡∏≠‡∏ô' },
    { id: 'avatar_pinata', type: 'avatar', name: 'pinata', icon: 'ü™Ö', cost: 200, value: 'ü™Ö', desc: '‡∏≠‡∏ß‡∏ï‡∏≤‡∏£‡∏õ‡∏µ‡∏ô‡∏ï‡∏≤' },
    
    // 250 XP
    { id: 'avatar_sun', type: 'avatar', name: '‡∏î‡∏ß‡∏á‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå', icon: '‚òÄÔ∏è', cost: 250, value: '‚òÄÔ∏è', desc: '‡∏≠‡∏ß‡∏ï‡∏≤‡∏£‡∏î‡∏≤‡∏ß‡∏§‡∏Å‡∏©‡πå‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏•‡∏≤‡∏á' },
    { id: 'avatar_dog', type: 'avatar', name: '‡∏™‡∏∏‡∏ô‡∏±‡∏Ç', icon: 'üê∂', cost: 250, value: 'üê∂', desc: '‡∏≠‡∏ß‡∏ï‡∏≤‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏ú‡∏π‡πâ‡∏ã‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏ï‡∏¢‡πå' },
    { id: 'avatar_cat', type: 'avatar', name: '‡πÅ‡∏°‡∏ß', icon: 'üò∫', cost: 250, value: 'üò∫', desc: '‡∏≠‡∏ß‡∏ï‡∏≤‡∏£‡πÅ‡∏°‡∏ß‡πÄ‡∏´‡∏°‡∏µ‡∏¢‡∏ß' },
    { id: 'avatar_monkey', type: 'avatar', name: '‡∏•‡∏¥‡∏á', icon: 'üêµ', cost: 250, value: 'üêµ', desc: '‡∏≠‡∏ß‡∏ï‡∏≤‡∏£‡∏•‡∏¥‡∏á' },
    { id: 'avatar_koala', type: 'avatar', name: '‡πÇ‡∏Ñ‡∏≠‡∏≤‡∏•‡∏≤', icon: 'üê®', cost: 250, value: 'üê®', desc: '‡∏≠‡∏ß‡∏ï‡∏≤‡∏£‡πÇ‡∏Ñ‡∏≠‡∏≤‡∏•‡∏≤' },
    { id: 'item_xp_2x', type: 'consumable', name: '‡∏Ñ‡∏π‡∏ì XP x2', icon: '‚ú®', cost: 250, value: 'xp_2x', desc: '‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö XP 2 ‡πÄ‡∏ó‡πà‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏à‡∏ö' },
    { id: 'item_undo', type: 'consumable', name: '‡πÅ‡∏Å‡πâ‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡∏°‡πà', icon: '‚Ü©Ô∏è', cost: 250, value: 'undo', desc: '‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ï‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏ï‡∏≠‡∏ö‡∏ú‡∏¥‡∏î‡πÑ‡∏î‡πâ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á' },
    
    // 300 XP
    { id: 'avatar_rocket', type: 'avatar', name: '‡∏à‡∏£‡∏ß‡∏î', icon: 'üöÄ', cost: 300, value: 'üöÄ', desc: '‡∏≠‡∏ß‡∏ï‡∏≤‡∏£‡∏à‡∏£‡∏ß‡∏î‡∏ó‡∏∞‡∏¢‡∏≤‡∏ô‡∏ü‡πâ‡∏≤' },
    { id: 'avatar_microbe', type: 'avatar', name: '‡∏à‡∏∏‡∏•‡∏¥‡∏ô‡∏ó‡∏£‡∏µ‡∏¢‡πå', icon: 'ü¶†', cost: 300, value: 'ü¶†', desc: '‡∏≠‡∏ß‡∏ï‡∏≤‡∏£‡∏™‡∏¥‡πà‡∏á‡∏°‡∏µ‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏•‡πá‡∏Å' },
    
    { id: 'title_scholar', type: 'title', name: '‡∏ú‡∏π‡πâ‡πÉ‡∏ù‡πà‡∏£‡∏π‡πâ', icon: 'üìö', cost: 300, value: '‡∏ú‡∏π‡πâ‡πÉ‡∏ù‡πà‡∏£‡∏π‡πâ', desc: '‡∏â‡∏≤‡∏¢‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô' },
    
    // 350 XP
    { id: 'avatar_satellite', type: 'avatar', name: '‡∏î‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏°', icon: 'üõ∞Ô∏è', cost: 350, value: 'üõ∞Ô∏è', desc: '‡∏≠‡∏ß‡∏ï‡∏≤‡∏£‡∏î‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏°‡∏™‡∏≥‡∏£‡∏ß‡∏à' },
    { id: 'avatar_telescope', type: 'avatar', name: '‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÇ‡∏ó‡∏£‡∏ó‡∏£‡∏£‡∏®‡∏ô‡πå', icon: 'üî≠', cost: 350, value: 'üî≠', desc: '‡∏≠‡∏ß‡∏ï‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡∏™‡πà‡∏≠‡∏á‡∏î‡∏≤‡∏ß' },
    
    // 400 XP
    { id: 'avatar_atom', type: 'avatar', name: '‡∏≠‡∏∞‡∏ï‡∏≠‡∏°', icon: '‚öõÔ∏è', cost: 400, value: '‚öõÔ∏è', desc: '‡∏≠‡∏ß‡∏ï‡∏≤‡∏£‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏≠‡∏∞‡∏ï‡∏≠‡∏°' },
    { id: 'avatar_dna', type: 'avatar', name: '‡∏î‡∏µ‡πÄ‡∏≠‡πá‡∏ô‡πÄ‡∏≠', icon: 'üß¨', cost: 400, value: 'üß¨', desc: '‡∏≠‡∏ß‡∏ï‡∏≤‡∏£‡πÄ‡∏Å‡∏•‡∏µ‡∏¢‡∏ß‡∏Ñ‡∏π‡πà' },
    
    // 450 XP
    { id: 'avatar_owl', type: 'avatar', name: '‡∏ô‡∏Å‡∏Æ‡∏π‡∏Å', icon: 'ü¶â', cost: 450, value: 'ü¶â', desc: '‡∏≠‡∏ß‡∏ï‡∏≤‡∏£‡∏ô‡∏Å‡∏Æ‡∏π‡∏Å‡∏ú‡∏π‡πâ‡∏£‡∏≠‡∏ö‡∏£‡∏π‡πâ' },
    { id: 'avatar_fox', type: 'avatar', name: '‡∏™‡∏∏‡∏ô‡∏±‡∏Ç‡∏à‡∏¥‡πâ‡∏á‡∏à‡∏≠‡∏Å', icon: 'ü¶ä', cost: 450, value: 'ü¶ä', desc: '‡∏≠‡∏ß‡∏ï‡∏≤‡∏£‡∏™‡∏∏‡∏ô‡∏±‡∏Ç‡∏à‡∏¥‡πâ‡∏á‡∏à‡∏≠‡∏Å‡πÄ‡∏à‡πâ‡∏≤‡πÄ‡∏•‡πà‡∏´‡πå' },
    
    // 500 XP
    { id: 'avatar_brain', type: 'avatar', name: '‡∏™‡∏°‡∏≠‡∏á', icon: 'üß†', cost: 500, value: 'üß†', desc: '‡∏≠‡∏ß‡∏ï‡∏≤‡∏£‡∏Ñ‡∏•‡∏±‡∏á‡∏õ‡∏±‡∏ç‡∏ç‡∏≤' },
    { id: 'avatar_wizard', type: 'avatar', name: '‡∏û‡πà‡∏≠‡∏°‡∏î', icon: 'üßô', cost: 500, value: 'üßô', desc: '‡∏≠‡∏ß‡∏ï‡∏≤‡∏£‡∏û‡πà‡∏≠‡∏°‡∏î‡∏ú‡∏π‡πâ‡∏ó‡∏£‡∏á‡∏û‡∏•‡∏±‡∏á' },
    { id: 'theme_forest', type: 'theme', name: '‡∏õ‡πà‡∏≤‡πÑ‡∏°‡πâ (Forest)', icon: 'üå≤', cost: 500, value: 'theme-forest', desc: '‡∏ò‡∏µ‡∏°‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥' },
    
    // 600 XP
    { id: 'avatar_lion', type: 'avatar', name: '‡∏™‡∏¥‡∏á‡πÇ‡∏ï', icon: 'ü¶Å', cost: 600, value: 'ü¶Å', desc: '‡∏≠‡∏ß‡∏ï‡∏≤‡∏£‡πÄ‡∏à‡πâ‡∏≤‡∏õ‡πà‡∏≤' },
    { id: 'avatar_tiger', type: 'avatar', name: '‡πÄ‡∏™‡∏∑‡∏≠', icon: 'üêØ', cost: 600, value: 'üêØ', desc: '‡∏≠‡∏ß‡∏ï‡∏≤‡∏£‡∏û‡∏¢‡∏±‡∏Ñ‡∏Ü‡πå' },
    
    // 800 XP
    { id: 'avatar_ninja', type: 'avatar', name: '‡∏ô‡∏¥‡∏ô‡∏à‡∏≤', icon: 'ü•∑', cost: 800, value: 'ü•∑', desc: '‡∏ô‡∏±‡∏Å‡∏£‡∏ö‡πÄ‡∏á‡∏≤' },
    { id: 'avatar_trex', type: 'avatar', name: 'T-rex', icon: 'ü¶ñ', cost: 800, value: 'ü¶ñ', desc: '‡∏≠‡∏ß‡∏ï‡∏≤‡∏£T-rex' },
    { id: 'theme_sunset', type: 'theme', name: '‡∏û‡∏£‡∏∞‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå‡∏ï‡∏Å (Sunset)', icon: 'üåÖ', cost: 800, value: 'theme-sunset', desc: '‡∏ò‡∏µ‡∏°‡∏™‡∏µ‡∏™‡πâ‡∏°‡∏≠‡∏ö‡∏≠‡∏∏‡πà‡∏ô' },
    { id: 'theme_ocean', type: 'theme', name: '‡∏°‡∏´‡∏≤‡∏™‡∏°‡∏∏‡∏ó‡∏£ (Ocean)', icon: 'üåä', cost: 800, value: 'theme-ocean', desc: '‡∏ò‡∏µ‡∏°‡∏™‡∏µ‡∏ü‡πâ‡∏≤‡∏ô‡πâ‡∏≥‡∏ó‡∏∞‡πÄ‡∏•' },
    
    // 1000 XP
    { id: 'avatar_dragon', type: 'avatar', name: '‡∏°‡∏±‡∏á‡∏Å‡∏£', icon: 'üêâ', cost: 1000, value: 'üêâ', desc: '‡∏≠‡∏ß‡∏ï‡∏≤‡∏£‡∏°‡∏±‡∏á‡∏Å‡∏£‡πÉ‡∏ô‡∏ï‡∏≥‡∏ô‡∏≤‡∏ô' },
    { id: 'theme_berry', type: 'theme', name: '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏£‡∏µ‡πà (Berry)', icon: 'üçá', cost: 1000, value: 'theme-berry', desc: '‡∏ò‡∏µ‡∏°‡∏™‡∏µ‡∏°‡πà‡∏ß‡∏á‡∏™‡∏î‡πÉ‡∏™' },
    
    // 1200 XP
    { id: 'avatar_unicorn', type: 'avatar', name: '‡∏¢‡∏π‡∏ô‡∏¥‡∏Ñ‡∏≠‡∏£‡πå‡∏ô', icon: 'ü¶Ñ', cost: 1200, value: 'ü¶Ñ', desc: '‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏ß‡∏¥‡πÄ‡∏®‡∏©‡∏´‡∏≤‡∏¢‡∏≤‡∏Å' },
    
    
    // 2000 XP
    { id: 'title_master', type: 'title', name: '‡∏õ‡∏£‡∏°‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå', icon: 'üéì', cost: 2000, value: '‡∏õ‡∏£‡∏°‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå', desc: '‡∏â‡∏≤‡∏¢‡∏≤‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á' },
    { id: 'theme_sakura', type: 'theme', name: '‡∏ã‡∏≤‡∏Å‡∏∏‡∏£‡∏∞ (Sakura)', icon: 'üå∏', cost: 2000, value: 'theme-sakura', desc: '‡∏ò‡∏µ‡∏°‡∏™‡∏µ‡∏ä‡∏°‡∏û‡∏π‡∏≠‡πà‡∏≠‡∏ô‡∏´‡∏ß‡∏≤‡∏ô' },
    
    // 5000 XP
    { id: 'title_rich', type: 'title', name: '‡πÄ‡∏®‡∏£‡∏©‡∏ê‡∏µ XP', icon: 'üí∞', cost: 5000, value: '‡πÄ‡∏®‡∏£‡∏©‡∏ê‡∏µ XP', desc: '‡∏â‡∏≤‡∏¢‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏°‡∏±‡πà‡∏á‡∏Ñ‡∏±‡πà‡∏á' },
    { id: 'theme_dark', type: 'theme', name: '‡∏£‡∏±‡∏ï‡∏ï‡∏¥‡∏Å‡∏≤‡∏• (Midnight)', icon: 'üåë', cost: 5000, value: 'theme-midnight', desc: '‡∏ò‡∏µ‡∏°‡∏™‡∏µ‡∏°‡∏∑‡∏î‡∏•‡∏∂‡∏Å‡∏•‡∏±‡∏ö' },
];

export function getAvatarFrameClass(avatar, size = 'default') { // 'default' or 'small'
    const shopItem = SHOP_ITEMS.find(i => i.value === avatar && i.type === 'avatar');
    if (!shopItem) return 'ring-2 ring-gray-200 dark:ring-gray-700'; // Default

    const ringWidth = size === 'small' ? 'ring-1' : 'ring-2';

    if (shopItem.cost >= 1000) return `${ringWidth} ring-yellow-400 legendary-frame`;
    if (shopItem.cost >= 500) return `${ringWidth} ring-purple-500`;
    return `${ringWidth} ring-green-500`;
}

export function getLevelBorderClass(level) {
    if (level >= 20) return 'bg-gradient-to-br from-red-500 via-yellow-400 to-green-500 animate-pulse'; // Rainbow
    if (level >= 15) return 'bg-gradient-to-br from-cyan-300 to-blue-500'; // Diamond
    if (level >= 10) return 'bg-gradient-to-br from-yellow-300 to-amber-500'; // Gold
    if (level >= 5) return 'bg-gradient-to-br from-blue-400 to-cyan-500'; // Sapphire
    return 'bg-gray-300 dark:bg-gray-600'; // Bronze/Gray
}

export class Gamification {
    constructor() {
        this.storageKey = 'app_gamification_data';
        this.authManager = authManager;

        const isNewToGamification = !localStorage.getItem(this.storageKey);
        
        this.state = this.loadState();
        
        // NEW: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å LocalStorage
        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ Data Inconsistency ‡πÄ‡∏ä‡πà‡∏ô XP ‡∏£‡∏ß‡∏°‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ XP ‡∏¢‡πà‡∏≠‡∏¢
        // ‡∏ã‡∏∂‡πà‡∏á‡∏≠‡∏≤‡∏à‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
        if (this.ensureConsistency()) {
            this.saveState();
        }
        
        const today = new Date().toDateString();
        if (this.state.lastQuestDate !== today) {
            this.state.activeQuests = this.generateDailyQuests();
            this.state.rerolls = 3;
            this.state.lastQuestDate = today;
            this.state.dailyQuest = null; // Clear legacy quest data if any
        }

        // Initial level up check in case quests were completed offline
        // and the user just came back online.
        this.updateLevel();
        this.saveState();

        if (isNewToGamification) {
            this.syncProgress();
        }

        this.updateStreak();
        this.applyTheme(this.state.selectedTheme);
        this.updateHeaderAvatar();

        // IMPROVEMENT: Cross-tab synchronization
        // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Tab ‡∏≠‡∏∑‡πà‡∏ô ‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏ô‡∏µ‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        window.addEventListener('storage', (e) => {
            if (e.key === this.storageKey) {
                this.state = this.loadState();
                this.onStateUpdated();
            }
        });

        // ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö AuthManager ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Login ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
        this.authManager.onUserChange(async (user) => {
            // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡∏à‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡πÄ‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏°‡∏≤‡∏à‡∏≤‡∏Å Cloud ‡∏´‡∏£‡∏∑‡∏≠ Local)
            try {
                const data = await this.authManager.loadUserData();
                if (data) {
                    // Merge data from Cloud with Default State for completeness
                    this.state = { ...this.getDefaultState(), ...data };

                    // --- Data Consistency Check & Correction ---
                    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡πÉ‡∏´‡∏°‡πà
                    // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Cloud ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏≥‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
                    let needsSave = this.ensureConsistency();

                    // Auto-update name from Google account on first login (if still default)
                    if (user) {
                        const isDefaultName = this.state.displayName === '‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (Guest)' || !this.state.displayName;
                        if (isDefaultName) {
                            this.state.displayName = user.displayName || (user.email ? user.email.split('@')[0] : '‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô');
                            needsSave = true;
                        }
                    }

                    if (needsSave) {
                        this.saveState(); // Save corrected data back to the cloud
                    }

                    // Check Streak and update UI
                    this.updateStreak();
                    this.onStateUpdated();
                }
            } catch (error) {
                console.error("Failed to load user data on auth change (client might be offline):", error);
                // Even if cloud fails, we can still proceed with local data.
                // The state is already loaded from localStorage in the constructor.
                // We can just trigger a UI update to be safe.
                this.onStateUpdated();
            }
        });
    }

    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• XP
    // Logic: ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏´‡∏≤‡∏ú‡∏•‡∏£‡∏ß‡∏° XP ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏´‡∏°‡∏ß‡∏î‡∏¢‡πà‡∏≠‡∏¢ (Proficiency) ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö XP ‡∏´‡∏•‡∏±‡∏Å (Physics/Earth)
    // ‡∏´‡∏≤‡∏Å XP ‡∏´‡∏•‡∏±‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏ú‡∏•‡∏£‡∏ß‡∏° (‡∏ã‡∏∂‡πà‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏ó‡∏≤‡∏á‡∏ó‡∏§‡∏©‡∏é‡∏µ) ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤ XP ‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏´‡πâ‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    ensureConsistency() {
        let needsSave = false;
        let calculatedAstroTrackXP = 0;
        let calculatedEarthTrackXP = 0;

        if (typeof this.state.oceanographyXP !== 'number') { this.state.oceanographyXP = Number(this.state.oceanographyXP) || 0; needsSave = true; }
        // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ñ‡πà‡∏≤ XP ‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç
        if (typeof this.state.xp !== 'number') { this.state.xp = Number(this.state.xp) || 0; needsSave = true; }
        if (typeof this.state.astronomyTrackXP !== 'number') { this.state.astronomyTrackXP = Number(this.state.astronomyTrackXP) || 0; needsSave = true; }
        if (typeof this.state.earthTrackXP !== 'number') { this.state.earthTrackXP = Number(this.state.earthTrackXP) || 0; needsSave = true; }

        // 2. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ú‡∏•‡∏£‡∏ß‡∏° XP ‡∏à‡∏≤‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏¢‡πà‡∏≠‡∏¢ (Proficiency Groups)
        for (const group of Object.values(PROFICIENCY_GROUPS)) {
            const groupXP = Number(this.state[group.field]) || 0;
            
            if (this.state[group.field] !== groupXP && this.state[group.field] !== undefined) {
                this.state[group.field] = groupXP;
                needsSave = true;
            }

            if (group.track === 'astronomy') {
                calculatedAstroTrackXP += groupXP;
            } else if (group.track === 'earth') {
                calculatedEarthTrackXP += groupXP;
            }
        }

        // 3. ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç XP ‡∏Ç‡∏≠‡∏á‡∏™‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡∏´‡∏•‡∏±‡∏Å‡∏´‡∏≤‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡∏´‡∏°‡∏ß‡∏î‡∏¢‡πà‡∏≠‡∏¢
        // (XP ‡∏´‡∏•‡∏±‡∏Å‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡πÑ‡∏î‡πâ ‡∏´‡∏≤‡∏Å‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡πÇ‡∏à‡∏ó‡∏¢‡πå‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ ‡πÅ‡∏ï‡πà‡∏´‡πâ‡∏≤‡∏°‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤)
        if (this.state.astronomyTrackXP < calculatedAstroTrackXP) {
            console.log(`Correcting astronomyTrackXP from ${this.state.astronomyTrackXP} to ${calculatedAstroTrackXP}`);
            this.state.astronomyTrackXP = calculatedAstroTrackXP;
            needsSave = true;
        }
        if (this.state.earthTrackXP < calculatedEarthTrackXP) {
            console.log(`Correcting earthTrackXP from ${this.state.earthTrackXP} to ${calculatedEarthTrackXP}`);
            this.state.earthTrackXP = calculatedEarthTrackXP;
            needsSave = true;
        }

        // 4. Reconcile Total XP with the sum of its parts (Physics, Earth, General)
        // This ensures that data from older versions (without generalXP) is corrected.
        const sumOfParts = (this.state.astronomyTrackXP || 0) + (this.state.earthTrackXP || 0) + (this.state.generalXP || 0);

        if (this.state.xp < sumOfParts) {
            // This case is unlikely but indicates a major inconsistency.
            // The total XP should never be less than the sum of its components.
            // We correct the total XP to match the sum.
            console.log(`Correcting total XP upwards from ${this.state.xp} to ${sumOfParts}`);
            this.state.xp = sumOfParts;
            needsSave = true;
        } else if (this.state.xp > sumOfParts) {
            // This is the more likely case for older data:
            // Total XP was incremented, but the parts (especially generalXP) were not.
            // We attribute the difference to generalXP.
            const difference = this.state.xp - sumOfParts;
            console.log(`Attributing unaccounted ${difference} XP to generalXP.`);
            this.state.generalXP = (this.state.generalXP || 0) + difference;
            needsSave = true;
        }

        return needsSave;
    }

    getDefaultState() {
        return {
            level: 1,
            xp: 0,
            astronomyTrackXP: 0,
            earthTrackXP: 0,
            badges: [],
            quizzesCompleted: 0,
            lastLogin: null,
            streak: 0,
            activeQuests: [],
            rerolls: 3,
            lastQuestDate: null,
            avatar: 'üßë‚Äçüéì',
            displayName: '‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (Guest)',
            totalCorrectAnswers: 0,
            questHistory: [],
            unlockedAchievements: [],
            selectedTitle: null,
            inventory: [],
            consumables: {},
            selectedTheme: null,
            correctStreak: 0,
            perfectScores: 0,
            highScores80: 0,
            weekendQuizzesCompleted: 0,
            astronomyXP: 0, geologyXP: 0, meteorologyXP: 0, oceanographyXP: 0,
            freeNameChangeAvailable: true, generalXP: 0, accumulatedQuestionsForBonus: 0,
        };
    }

    updateLevel() {
        let leveledUp = false;
        // Loop to handle multiple level-ups in one go, but sequentially.
        while (true) {
            const currentLevel = this.state.level || 1;
            const nextLevelThreshold = XP_THRESHOLDS.find(t => t.level === currentLevel + 1);

            if (!nextLevelThreshold) {
                break; // Max level reached
            }

            // Check if XP and quest conditions are met for the *next* level
            if (this.state.xp >= nextLevelThreshold.xp && this.isQuestCompleted(nextLevelThreshold.quest)) {
                this.state.level = currentLevel + 1;
                leveledUp = true;
            } else {
                break; // Cannot level up further
            }
        }
        return leveledUp;
    }

    loadState() {
        const stored = localStorage.getItem(this.storageKey);
        let state = null;
        try {
            if (stored) {
                state = JSON.parse(stored);
            }
        } catch (e) {
            console.error("Error loading gamification state:", e);
        }

        // IMPROVEMENT: Define Default State clearly
        // Merge loaded state with defaults to ensure all keys exist (Robustness)
        state = { ...this.getDefaultState(), ...(state || {}) };
        
        return state;
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡πÇ‡∏à‡∏ó‡∏¢‡πå‡πÄ‡∏Å‡πà‡∏≤‡πÜ ‡∏°‡∏≤‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏õ‡πá‡∏ô XP ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
    // Logic: ‡∏™‡πÅ‡∏Å‡∏ô LocalStorage ‡∏´‡∏≤ key ‡∏ó‡∏µ‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ 'quizState-'
    // ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì XP ‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡πÄ‡∏•‡πà‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏°‡∏µ‡∏£‡∏∞‡∏ö‡∏ö Gamification
    syncProgress() { // This function is for migrating old user data.
        let totalXP = 0;
        let astronomyTrackXP = 0;
        let earthTrackXP = 0;
        let completed = 0;
        let totalCorrect = 0;
        let perfectScores = 0;
        let highScores80 = 0;
        const topicXPs = {};
        let weekendQuizzes = 0;
        let generalQuizXP = 0;

        // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô LocalStorage
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏à‡∏≠‡∏Ñ‡∏µ‡∏¢‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡πÇ‡∏à‡∏ó‡∏¢‡πå (quizState-...)
            if (key && key.startsWith('quizState-')) {
                try {
                    const data = JSON.parse(localStorage.getItem(key));
                    // NEW: Check for shuffledQuestions to ensure we can calculate XP accurately
                    if (data && data.userAnswers && data.shuffledQuestions) {
                        let calculatedXp = 0;
                        let quizAstronomyXP = 0;
                        let quizEarthTrackXP = 0;

                        data.userAnswers.forEach((ans, index) => {
                            if (ans && ans.isCorrect) {
                                const question = data.shuffledQuestions[index];
                                // Award 5 XP for complex questions, 4 for others
                                if (question && (question.type === 'multiple-select' || question.type === 'fill-in-number')) {
                                    calculatedXp += 5;
                                } else {
                                    calculatedXp += 4;
                                }
                            }
                        });
                        
                        const xp = calculatedXp;
                        const correctCount = data.score || 0;

                        totalXP += xp;
                        totalCorrect += correctCount;
                        // ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÄ‡∏™‡∏£‡πá‡∏à (‡∏î‡∏π‡∏à‡∏≤‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏ï‡∏≠‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î)
                        const totalQ = data.shuffledQuestions ? data.shuffledQuestions.length : 0;
                        const answered = data.userAnswers.filter(a => a).length;
                        if (totalQ > 0 && answered >= totalQ) {
                            completed++;

                            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á
                            const percentage = Math.round((correctCount / totalQ) * 100);
                            const isCustom = key.includes('custom');
                            if (!isCustom || (isCustom && totalQ >= 20)) {
                                if (percentage === 100) perfectScores++;
                                if (percentage >= 80) highScores80++;
                            }

                            // Check for weekend completion based on timestamp
                            if (data.lastAttemptTimestamp) {
                                const date = new Date(data.lastAttemptTimestamp);
                                const day = date.getDay();
                                if (day === 0 || day === 6) {
                                    weekendQuizzes++;
                                }
                            }
                        }

                        // Calculate Topic XP
                        data.userAnswers.forEach((ans, index) => {
                            if (ans && ans.isCorrect) {
                                const question = data.shuffledQuestions[index];
                                const points = (question && (question.type === 'multiple-select' || question.type === 'fill-in-number')) ? 5 : 4;
                                
                                let subCatStr = '';
                                if (ans.subCategory) {
                                    if (typeof ans.subCategory === 'string') subCatStr = ans.subCategory;
                                    else if (ans.subCategory.main) subCatStr = ans.subCategory.main;
                                }
                                for (const [groupKey, groupDef] of Object.entries(PROFICIENCY_GROUPS)) {
                                    if (groupDef.keywords.some(k => subCatStr.includes(k))) {
                                        topicXPs[groupDef.field] = (topicXPs[groupDef.field] || 0) + points;
                                        
                                        // Accumulate track XP based on proficiency group
                                        if (groupDef.track === 'astronomy') {
                                            quizAstronomyXP += points;
                                        } else if (groupDef.track === 'earth') {
                                            quizEarthTrackXP += points;
                                        }
                                        
                                        break;
                                    }
                                }
                            }
                        });

                        // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å Proficiency Group ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡∏î‡∏π‡∏à‡∏≤‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå
                        if (quizAstronomyXP === 0 && quizEarthTrackXP === 0) {
                            let category = 'General';
                            const firstAns = data.userAnswers.find(a => a);
                            if (firstAns) {
                                if (firstAns.sourceQuizCategory) category = firstAns.sourceQuizCategory;
                                else if (firstAns.subCategory) {
                                    category = typeof firstAns.subCategory === 'object' ? firstAns.subCategory.main : firstAns.subCategory;
                                }
                            }
                            
                            const lowerCat = String(category).toLowerCase();
                            if (lowerCat.includes('physics') || lowerCat.includes('‡∏ü‡∏¥‡∏™‡∏¥‡∏Å‡∏™‡πå') || key.includes('phy_') || lowerCat.includes('astronomy') || lowerCat.includes('‡∏î‡∏≤‡∏£‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå') || lowerCat.includes('space') || lowerCat.includes('‡∏≠‡∏ß‡∏Å‡∏≤‡∏®') || key.includes('astro') || key.includes('junior') || key.includes('senior')) {
                                quizAstronomyXP = calculatedXp;
                            } else if (lowerCat.includes('earth') || lowerCat.includes('‡πÇ‡∏•‡∏Å') || lowerCat.includes('‡∏ß‡∏¥‡∏ó‡∏¢‡πå‡πÇ‡∏•‡∏Å') || key.includes('ess_') || key.includes('ES') || key.includes('ESR') || lowerCat.includes('geology') || lowerCat.includes('‡∏ò‡∏£‡∏ì‡∏µ‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤') || lowerCat.includes('meteorology') || lowerCat.includes('‡∏≠‡∏∏‡∏ï‡∏∏‡∏ô‡∏¥‡∏¢‡∏°‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤') || lowerCat.includes('oceanography') || lowerCat.includes('‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå') || key.includes('earth')) {
                                quizEarthTrackXP = calculatedXp;
                            }
                        }

                        // The difference is general XP
                        generalQuizXP += (calculatedXp - quizAstronomyXP - quizEarthTrackXP);

                        astronomyTrackXP += quizAstronomyXP;
                        earthTrackXP += quizEarthTrackXP;
                    }
                } catch (e) {
                    console.warn("Skipping invalid quiz state during sync:", key);
                }
            }
        }

        // ‡∏ñ‡πâ‡∏≤‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤ ‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        if (totalXP > 0) {
            this.state.xp = totalXP;
            this.state.astronomyTrackXP = astronomyTrackXP;
            this.state.earthTrackXP = earthTrackXP;
            this.state.quizzesCompleted = completed;
            this.state.totalCorrectAnswers = totalCorrect;
            this.state.perfectScores = perfectScores;
            this.state.highScores80 = highScores80;
            this.state.weekendQuizzesCompleted = weekendQuizzes;
            this.state.oceanographyXP = topicXPs.oceanographyXP || 0;
            this.state.generalXP = generalQuizXP;
            
            // Apply calculated topic XPs
            for (const [field, xp] of Object.entries(topicXPs)) {
                this.state[field] = xp;
            }

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            this.checkBadges(0); 
            this.saveState();
            console.log(`Synced old progress: ${totalXP} XP, ${completed} Quizzes`);
        }
    }

    saveState() {
        // ‡πÉ‡∏ä‡πâ AuthManager ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏à‡∏∞‡∏•‡∏á‡∏ó‡∏±‡πâ‡∏á LocalStorage ‡πÅ‡∏•‡∏∞ Firestore ‡∏ñ‡πâ‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô)
        this.authManager.saveUserData(this.state).catch(e => {
            console.error("Error saving gamification state via AuthManager:", e);
        });
        this.onStateUpdated(); // Trigger UI updates ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏•‡∏∑‡πà‡∏ô‡πÑ‡∏´‡∏•
    }

    async forceCloudSync() {
        if (!this.authManager.currentUser) return false;
        try {
            const data = await this.authManager.loadUserData();
            if (data) {
                this.state = { ...this.getDefaultState(), ...data };
                this.updateStreak();
                this.onStateUpdated();
                return true;
            }
        } catch (e) {
            console.error("Force sync failed:", e);
        }
        return false;
    }

    // IMPROVEMENT: Centralized UI Update Trigger
    onStateUpdated() {
        this.updateHeaderAvatar();
        this.applyTheme(this.state.selectedTheme);
        // Dispatch event for other components (e.g. profile page charts) to react
        window.dispatchEvent(new CustomEvent('gamification-updated', { detail: this.state }));
    }

    setAvatar(avatar) {
        this.state.avatar = avatar;
        this.saveState();
    }

    setDisplayName(name) {
        this.state.displayName = name;
        this.saveState();
    }

    equipTitle(title) {
        this.state.selectedTitle = title;
        this.saveState();
    }

    equipTheme(themeValue) {
        this.state.selectedTheme = themeValue;
        this.saveState();
    }

    buyItem(itemId) {
        const item = SHOP_ITEMS.find(i => i.id === itemId);
        if (!item) return { success: false, message: "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" };
        if (this.state.xp < item.cost) return { success: false, message: "XP ‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠" };

        if (item.type === 'consumable') {
            this.state.xp -= item.cost;
            this.state.consumables[itemId] = (this.state.consumables[itemId] || 0) + 1;
            this.saveState();
            return { success: true, message: `‡∏ã‡∏∑‡πâ‡∏≠ ${item.name} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! (‡∏°‡∏µ: ${this.state.consumables[itemId]})`, item };
        } else {
            if (this.state.inventory.includes(itemId)) return { success: false, message: "‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß" };
            this.state.xp -= item.cost;
            this.state.inventory.push(itemId);
            
            // Check Shop Badges
            if (this.state.inventory.length >= 5 && !this.state.badges.includes('shop_spender')) {
                this.state.badges.push('shop_spender');
            }
            
            this.checkAchievements();
            this.saveState();
            return { success: true, message: `‡∏ã‡∏∑‡πâ‡∏≠ ${item.name} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`, item };
        }
    }

    useItem(itemId) {
        if (this.state.consumables[itemId] > 0) {
            this.state.consumables[itemId]--;
            this.saveState();
            return true;
        }
        return false;
    }

    getInventory() {
        return this.state.inventory || [];
    }

    getItemCount(itemId) {
        return this.state.consumables ? (this.state.consumables[itemId] || 0) : 0;
    }

    updateHeaderAvatar() {
        const profileLink = document.getElementById('main-header-profile-link');
        const user = this.authManager.currentUser;
        
        // Update Header Email
        const headerEmailEl = document.getElementById('user-hub-email');
        if (headerEmailEl) {
            if (user && user.email) {
                headerEmailEl.textContent = user.email;
                headerEmailEl.classList.remove('hidden');
            } else {
                headerEmailEl.classList.add('hidden');
            }
        }

        if (profileLink) {
            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô Guest (SVG) ‡πÅ‡∏ó‡∏ô‡∏≠‡∏ß‡∏ï‡∏≤‡∏£
            if (!user) {
                profileLink.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                `;
                profileLink.className = "flex items-center justify-center h-full w-full";
                return;
            }

            const avatar = this.state.avatar || 'üßë‚Äçüéì';
            const level = this.getCurrentLevel().level;

            // Ensure the container is round and clean
            profileLink.classList.add('rounded-full');
            const classesToRemove = [
                'ring-2', 'ring-4', 'ring-gray-200', 'dark:ring-gray-700',
                'ring-green-500', 'ring-purple-500', 'ring-yellow-400',
                'legendary-frame', 'p-0.5'
            ];
            profileLink.classList.remove(...classesToRemove);

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡∏°‡∏µ‡∏à‡∏∏‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢ /)
            const isImage = avatar.includes('/') || avatar.includes('.');
            let contentHtml = '';
            
            if (isImage) {
                contentHtml = `<img src="${avatar}" alt="Avatar" class="w-full h-full rounded-full object-cover">`;
            } else {
                contentHtml = `<span class="text-xl leading-none flex items-center justify-center h-full w-full select-none">${avatar}</span>`;
            }

            const levelBorderClass = getLevelBorderClass(level);
            const avatarFrameClass = getAvatarFrameClass(avatar, 'small');

            // Create nested structure: Level Border (Outer) -> Avatar Frame (Inner) -> Content
            profileLink.innerHTML = `
                <div class="w-full h-full rounded-full p-0.5 ${levelBorderClass} shadow-sm transition-all duration-300">
                    <div class="w-full h-full rounded-full bg-white dark:bg-gray-800 flex items-center justify-center overflow-hidden ${avatarFrameClass}">
                        ${contentHtml}
                    </div>
                </div>
            `;

            // Trigger Animation on the link itself
            profileLink.classList.remove('anim-avatar-pop');
            void profileLink.offsetWidth; // Force reflow
            profileLink.classList.add('anim-avatar-pop');
        } else {
            // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏ö Element (‡πÄ‡∏ä‡πà‡∏ô Header ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏¢‡∏π‡πà) ‡πÉ‡∏´‡πâ‡∏£‡∏≠‡∏à‡∏±‡∏ö‡∏ï‡∏≤‡∏î‡∏π‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡πÉ‡∏ô placeholder
            if (this.headerObserver) return; // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á Observer ‡∏ã‡πâ‡∏≥

            const placeholder = document.getElementById('main_header-placeholder');
            if (placeholder) {
                this.headerObserver = new MutationObserver(() => {
                    // ‡∏•‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡πÉ‡∏ô DOM
                    if (document.getElementById('main-header-profile-link')) {
                        this.updateHeaderAvatar();
                        this.headerObserver.disconnect(); // ‡∏´‡∏¢‡∏∏‡∏î‡∏î‡∏π‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏à‡∏≠‡πÅ‡∏•‡πâ‡∏ß
                        this.headerObserver = null;
                    }
                });
                this.headerObserver.observe(placeholder, { childList: true, subtree: true });
            }
        }
    }

    applyTheme(theme) {
        // Remove existing theme classes
        document.documentElement.classList.remove('theme-forest', 'theme-sunset', 'theme-ocean', 'theme-berry', 'theme-midnight');
        
        if (theme) {
            document.documentElement.classList.add(theme);
            
            // OPTIMIZATION: Set CSS Variables instead of generating full CSS rules
            const themeName = theme.replace('theme-', '');
            const colors = THEME_DEFINITIONS[themeName];
            
            if (colors) {
                const root = document.documentElement;
                root.style.setProperty('--theme-main', colors.main);
                root.style.setProperty('--theme-hover', colors.hover);
                root.style.setProperty('--theme-secondary', colors.secondary);
                root.style.setProperty('--theme-light-bg', colors.light_bg);
                root.style.setProperty('--theme-dark-bg', colors.dark_bg);
                root.style.setProperty('--theme-ring', colors.ring);
                root.style.setProperty('--theme-dark-text', colors.dark_text || colors.main);
            }

            this.injectThemeStyles();
        } else {
            // Reset variables if needed (optional, as removing class usually suffices)
            const root = document.documentElement;
            root.style.removeProperty('--theme-main');
            root.style.removeProperty('--theme-hover');
            root.style.removeProperty('--theme-secondary');
            root.style.removeProperty('--theme-light-bg');
            root.style.removeProperty('--theme-dark-bg');
            root.style.removeProperty('--theme-ring');
            root.style.removeProperty('--theme-dark-text');
        }
    }

    injectThemeStyles() {
        if (document.getElementById('gamification-theme-styles')) return;

        const style = document.createElement('style');
        style.id = 'gamification-theme-styles';
        
        // OPTIMIZATION: Use CSS Variables in a single set of rules
        const allStyles = `
            @keyframes avatarPop {
                0% { transform: scale(1); }
                50% { transform: scale(1.25); }
                100% { transform: scale(1); }
            }
            .anim-avatar-pop {
                animation: avatarPop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            }

            /* NEW: Rewind Animation for Undo Power-up */
            @keyframes rewind-flash {
              0% { filter: brightness(1) blur(0); }
              50% { 
                filter: brightness(1.5) blur(1px) saturate(0.5);
                transform: scale(1.01);
              }
              100% { filter: brightness(1) blur(0); }
            }
            .anim-rewind {
              animation: rewind-flash 0.4s ease-in-out;
            }

            /* NEW: Item Pop Animation */
            @keyframes itemPop {
                0% { transform: scale(1); }
                50% { transform: scale(1.2); }
                100% { transform: scale(1); }
            }
            .anim-item-pop {
                animation: itemPop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            }

            /* NEW: Legendary Frame Shimmer */
            @keyframes shimmer {
                0% { background-position: -200% 0; }
                100% { background-position: 200% 0; }
            }
            .legendary-frame {
                position: relative;
                overflow: hidden;
            }
            .legendary-frame::after {
                content: "";
                position: absolute;
                top: 0; left: 0; width: 100%; height: 100%;
                background: linear-gradient(120deg, transparent 30%, rgba(255, 255, 255, 0.6) 50%, transparent 70%);
                background-size: 200% 100%;
                animation: shimmer 3s infinite linear;
                border-radius: 9999px;
                pointer-events: none;
            }

            /* --- DYNAMIC THEME OVERRIDES USING VARIABLES --- */
            /* Only apply when a theme class is present on html/body */
            
            :root {
                /* Default fallback values to prevent breakage if vars aren't set */
                --theme-main: #3b82f6; 
                --theme-hover: #2563eb;
                --theme-secondary: #60a5fa;
                --theme-light-bg: #eff6ff;
                --theme-dark-bg: rgba(30, 58, 138, 0.5);
                --theme-ring: #60a5fa;
                --theme-dark-text: #60a5fa;
            }

            [class*="theme-"] ::selection {
                background-color: var(--theme-main);
                color: white;
            }

            [class*="theme-"] ::-webkit-scrollbar-thumb {
                background-color: var(--theme-secondary);
                border-radius: 10px;
            }

            /* Main UI & Quiz Page Accent */
            [class*="theme-"] .bg-blue-500,
            [class*="theme-"] .bg-blue-600,
            [class*="theme-"] .dark\\:bg-blue-600,
            [class*="theme-"] .bg-indigo-500,
            [class*="theme-"] .bg-indigo-600,
            [class*="theme-"] input[type="radio"]:checked,
            [class*="theme-"] input[type="checkbox"]:checked {
                background-color: var(--theme-main) !important;
                border-color: var(--theme-main) !important;
            }

            [class*="theme-"] .hover\\:bg-blue-600:hover,
            [class*="theme-"] .hover\\:bg-blue-700:hover,
            [class*="theme-"] .dark\\:hover\\:bg-blue-700:hover,
            [class*="theme-"] .hover\\:bg-indigo-600:hover,
            [class*="theme-"] .hover\\:bg-indigo-700:hover {
                background-color: var(--theme-hover) !important;
            }

            /* Text colors */
            [class*="theme-"] .text-blue-500,
            [class*="theme-"] .text-blue-600,
            [class*="theme-"] .text-blue-700,
            [class*="theme-"] .text-indigo-600,
            [class*="theme-"] .text-indigo-700 {
                color: var(--theme-main) !important;
            }

            /* Dark mode text */
            [class*="theme-"] .dark .text-blue-500,
            [class*="theme-"] .dark .text-blue-600,
            [class*="theme-"] .dark .text-blue-700,
            [class*="theme-"] .dark .text-indigo-600,
            [class*="theme-"] .dark .text-indigo-700,
            [class*="theme-"] .dark\\:text-blue-400,
            [class*="theme-"] .dark\\:text-blue-300 {
                color: var(--theme-dark-text) !important;
            }

            [class*="theme-"] .border-blue-500,
            [class*="theme-"] .border-blue-600,
            [class*="theme-"] .border-indigo-500,
            [class*="theme-"] .has-\\[\\:checked\\]\\:border-blue-500:checked,
            [class*="theme-"] .hover\\:border-blue-500:hover {
                border-color: var(--theme-main) !important;
            }

            [class*="theme-"] .focus\\:ring-blue-500:focus,
            [class*="theme-"] .focus\\:ring-indigo-500:focus {
                --tw-ring-color: var(--theme-ring) !important;
            }

            [class*="theme-"] .bg-blue-100,
            [class*="theme-"] .bg-blue-50,
            [class*="theme-"] .bg-indigo-50,
            [class*="theme-"] .bg-indigo-100,
            [class*="theme-"] .dark\\:bg-blue-900\\/30,
            [class*="theme-"] .dark\\:bg-indigo-900\\/30 {
                background-color: var(--theme-light-bg) !important;
            }
            
            [class*="theme-"] .dark .bg-blue-100, 
            [class*="theme-"] .dark .bg-blue-50,
            [class*="theme-"] .dark\\:bg-blue-900\\/50 {
                background-color: var(--theme-dark-bg) !important;
            }
            
            [class*="theme-"] .hover\\:bg-blue-200:hover { background-color: var(--theme-main) !important; opacity: 0.2; }
            [class*="theme-"] .dark\\:hover\\:bg-blue-800:hover { background-color: var(--theme-hover) !important; opacity: 0.4; }

            /* Gradients */
            [class*="theme-"] .from-blue-500,
            [class*="theme-"] .from-blue-600,
            [class*="theme-"] .from-indigo-500 {
                --tw-gradient-from: var(--theme-main) !important;
                --tw-gradient-to: var(--theme-secondary) !important;
                --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to) !important;
            }

            [class*="theme-"] .to-purple-600,
            [class*="theme-"] .to-indigo-500,
            [class*="theme-"] .to-blue-600 {
                --tw-gradient-to: var(--theme-secondary) !important;
            }

            /* Quiz Card Hovers */
            [class*="theme-"] .quiz-card:hover {
                border-color: var(--theme-main) !important;
                --tw-shadow-color: var(--theme-main) !important;
                box-shadow: 0 10px 15px -3px var(--theme-light-bg), 0 4px 6px -2px var(--theme-light-bg) !important;
            }
            [class*="theme-"] .dark .quiz-card:hover {
                box-shadow: 0 10px 15px -3px var(--theme-dark-bg), 0 4px 6px -2px var(--theme-dark-bg) !important;
            }

            [class*="theme-"] .quiz-card:hover h3 {
                color: var(--theme-main) !important;
            }
            [class*="theme-"] .quiz-card:hover .section-icon-container {
                background-color: var(--theme-light-bg) !important;
            }
            [class*="theme-"] .dark .quiz-card:hover .section-icon-container {
                background-color: var(--theme-dark-bg) !important;
            }

            /* Quiz Page Buttons */
            [class*="theme-"] #next-btn,
            [class*="theme-"] #review-btn,
            [class*="theme-"] #back-to-result-btn,
            [class*="theme-"] #restart-btn,
            [class*="theme-"] #start-btn {
                background-color: var(--theme-main) !important;
                color: white !important;
                border-color: transparent !important;
            }
            [class*="theme-"] #next-btn:hover,
            [class*="theme-"] #review-btn:hover,
            [class*="theme-"] #back-to-result-btn:hover,
            [class*="theme-"] #restart-btn:hover,
            [class*="theme-"] #start-btn:hover {
                background-color: var(--theme-hover) !important;
                box-shadow: 0 4px 12px var(--theme-dark-bg) !important;
            }

            [class*="theme-"] #prev-btn,
            [class*="theme-"] #skip-btn {
                background-color: var(--theme-light-bg) !important;
                color: var(--theme-main) !important;
                border: 1px solid var(--theme-main) !important;
            }
            [class*="theme-"] #prev-btn:hover,
            [class*="theme-"] #skip-btn:hover {
                background-color: var(--theme-main) !important;
                color: white !important;
            }

            [class*="theme-"] .option-btn:hover:not(:disabled) {
                border-color: var(--theme-main) !important;
                background-color: var(--theme-light-bg) !important;
                color: var(--theme-main) !important;
            }
        `;

        style.textContent = allStyles;
        document.head.appendChild(style);
    }

    resetProgress() {
        const defaultState = this.getDefaultState();
        // Preserve displayName, avatar, and theme on reset
        defaultState.displayName = this.state.displayName;
        defaultState.avatar = this.state.avatar;
        defaultState.selectedTheme = this.state.selectedTheme;
        
        this.state = defaultState;
        this.saveState();
    }

    incrementCorrectStreak() {
        this.state.correctStreak = (this.state.correctStreak || 0) + 1;
        this.saveState();
    }

    resetCorrectStreak() {
        this.state.correctStreak = 0;
        this.saveState();
    }

    updateEndQuizStats(percentage, questionCount = 0, isCustomQuiz = false) {
        // Logic: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ Perfect Score ‡∏´‡∏£‡∏∑‡∏≠ High Score
        // ‡∏´‡∏≤‡∏Å‡πÄ‡∏õ‡πá‡∏ô Custom Quiz ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 20 ‡∏Ç‡πâ‡∏≠‡∏à‡∏∂‡∏á‡∏à‡∏∞‡∏ô‡∏±‡∏ö‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏±‡πä‡∏°‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏î‡πâ‡∏ß‡∏¢‡πÇ‡∏à‡∏ó‡∏¢‡πå 1 ‡∏Ç‡πâ‡∏≠)
        // Check eligibility: Custom quizzes need at least 20 questions
        const isEligible = !isCustomQuiz || (isCustomQuiz && questionCount >= 20);
        
        if (isEligible) {
            if (percentage === 100) {
                this.state.perfectScores = (this.state.perfectScores || 0) + 1;
            }
            if (percentage >= 80) {
                this.state.highScores80 = (this.state.highScores80 || 0) + 1;
            }
            // No need to call saveState() here as it will be called later in the flow (e.g., by checkBadges)
        }
    }

    isQuestCompleted(quest) {
        if (!quest) return true; // No quest for this level, so it's "completed".

        switch (quest.type) {
            case 'correct_streak':
                return (this.state.correctStreak || 0) >= quest.target;
            case 'quizzes_completed':
                return (this.state.quizzesCompleted || 0) >= quest.target;
            case 'perfect_scores':
                return (this.state.perfectScores || 0) >= quest.target;
            case 'high_scores_80':
                return (this.state.highScores80 || 0) >= quest.target;
            case 'astronomy_level':
                return this.getAstronomyTrackLevel().level >= quest.target;
            case 'earth_level':
                return this.getEarthLevel().level >= quest.target;
            default:
                return false; // Unknown quest type
        }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏•‡πÄ‡∏ß‡∏•‡∏à‡∏≤‡∏Å XP ‡πÅ‡∏•‡∏∞‡∏™‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏
    getLevelInfo(xp, track = 'overall') {
        if (track !== 'overall') {
            // Original logic for other tracks
            let level = 0;
            for (const threshold of XP_THRESHOLDS) {
                if (xp >= threshold.xp) {
                    level = threshold.level;
                } else {
                    break;
                }
            }
            if (level === 0) level = 1;
            const currentLevelData = XP_THRESHOLDS[level - 1];
            const nextLevelData = XP_THRESHOLDS[level] || null;
            const titles = TRACK_TITLES[track] || TRACK_TITLES.overall;
            const titleIndex = Math.min(level - 1, titles.length - 1);
            let progressPercent = 100;
            if (nextLevelData) {
                const range = nextLevelData.xp - currentLevelData.xp;
                const gained = xp - currentLevelData.xp;
                progressPercent = range > 0 ? Math.min(100, Math.max(0, (gained / range) * 100)) : 100;
            }
            return { level, title: titles[titleIndex], currentXP: xp, nextLevelXP: nextLevelData ? nextLevelData.xp : null, progressPercent };
        }

        // --- REVISED LOGIC FOR OVERALL LEVEL ---
        // The level is now stored in the state. We just calculate progress towards the next one.
        const currentLevel = this.state.level || 1;
        
        const currentLevelData = XP_THRESHOLDS.find(t => t.level === currentLevel);
        const nextLevelData = XP_THRESHOLDS.find(t => t.level === currentLevel + 1);

        const titles = TRACK_TITLES.overall;
        const titleIndex = Math.min(currentLevel - 1, titles.length - 1);

        let xpProgressPercent = 100;
        let questProgressPercent = 100;
        let overallProgressPercent = 100;

        if (nextLevelData && currentLevelData) {
            // Calculate XP progress
            const xpRange = nextLevelData.xp - currentLevelData.xp;
            if (xpRange > 0) {
                xpProgressPercent = Math.min(100, Math.max(0, ((xp - currentLevelData.xp) / xpRange) * 100));
            }

            // Calculate Quest progress
            if (nextLevelData.quest) questProgressPercent = this.getQuestProgressPercent(nextLevelData.quest);
            
            // Overall progress is the minimum of the two
            overallProgressPercent = Math.min(xpProgressPercent, questProgressPercent);
        }

        return { level: currentLevel, title: titles[titleIndex], currentXP: xp, nextLevelXP: nextLevelData ? nextLevelData.xp : null, progressPercent: overallProgressPercent, nextLevelQuest: nextLevelData ? nextLevelData.quest : null };
    }

    getCurrentLevel() {
        return this.getLevelInfo(this.state.xp, 'overall');
    }

    getAstronomyTrackLevel() {
        return this.getLevelInfo(this.state.astronomyTrackXP, 'astronomy');
    }

    getEarthLevel() {
        return this.getLevelInfo(this.state.earthTrackXP, 'earth');
    }

    // Legacy support (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏Å‡πà‡∏≤‡πÑ‡∏°‡πà‡∏û‡∏±‡∏á)
    getNextLevel() {
        const info = this.getCurrentLevel();
        if (!info.nextLevelXP) return null;
        return { level: info.level + 1, xp: info.nextLevelXP };
    }

    getQuestProgressValue(quest) {
        if (!quest) return 0;
        switch (quest.type) {
            case 'correct_streak':
                return this.state.correctStreak || 0;
            case 'quizzes_completed':
                return this.state.quizzesCompleted || 0;
            case 'perfect_scores':
                return this.state.perfectScores || 0;
            case 'high_scores_80':
                return this.state.highScores80 || 0;
            case 'astronomy_level':
                return this.getAstronomyTrackLevel().level;
            case 'earth_level':
                return this.getEarthLevel().level;
            default:
                return 0;
        }
    }

    getQuestProgressPercent(quest) {
        if (!quest || this.isQuestCompleted(quest)) return 100;

        const currentProgress = this.getQuestProgressValue(quest);
        let baseValue = 0;

        // For level-based quests, progress starts from the base level (e.g., level 1)
        if (quest.type.endsWith('_level')) {
            baseValue = 1; // Assuming level quests start counting from level 1
        }

        const range = quest.target - baseValue;
        const gained = currentProgress - baseValue;

        return range > 0 ? Math.min(100, Math.max(0, (gained / range) * 100)) : 0;
    }

    // ‡∏™‡∏∏‡πà‡∏°‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡πÉ‡∏´‡∏°‡πà
    generateDailyQuests() {
        // ‡∏™‡∏∏‡πà‡∏°‡∏°‡∏≤ 3 ‡∏á‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô
        const shuffled = [...DAILY_QUESTS].sort(() => 0.5 - Math.random());
        return shuffled.slice(0, 3).map(q => ({
            ...q,
            progress: 0,
            completed: false,
            date: new Date().toDateString()
        }));
    }

    // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à (Reroll)
    rerollQuest(index) {
        if (this.state.rerolls <= 0) return { success: false, message: "‡∏´‡∏°‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡πÅ‡∏•‡πâ‡∏ß" };
        if (index < 0 || index >= this.state.activeQuests.length) return { success: false, message: "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à" };
        if (this.state.activeQuests[index].completed) return { success: false, message: "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏î‡πâ" };

        // ‡∏´‡∏≤‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà
        const currentIds = this.state.activeQuests.map(q => q.id);
        const available = DAILY_QUESTS.filter(q => !currentIds.includes(q.id));
        
        if (available.length === 0) return { success: false, message: "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏≠‡∏∑‡πà‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß" };

        const newQuest = available[Math.floor(Math.random() * available.length)];
        this.state.activeQuests[index] = {
            ...newQuest,
            progress: 0,
            completed: false,
            date: new Date().toDateString()
        };
        this.state.rerolls--;
        this.saveState();
        return { success: true, quest: this.state.activeQuests[index], rerollsLeft: this.state.rerolls };
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Streak (‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÉ‡∏ô constructor)
    updateStreak() {
        const today = new Date();
        const todayStr = today.toDateString();
        const lastLoginStr = this.state.lastLogin;

        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà
        if (lastLoginStr === todayStr) {
            if (this.state.streak === 0) {
                this.state.streak = 1;
                this.saveState();
            }
            return;
        }

        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô (Difference in days)
        const lastLoginDate = lastLoginStr ? new Date(lastLoginStr) : new Date();
        // Reset time part for accurate day calculation
        const t1 = new Date(today.getFullYear(), today.getMonth(), today.getDate()).getTime();
        const t2 = new Date(lastLoginDate.getFullYear(), lastLoginDate.getMonth(), lastLoginDate.getDate()).getTime();
        const diffDays = Math.floor((t1 - t2) / (1000 * 60 * 60 * 24));

        if (diffDays === 1) {
            // ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á (‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤ ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏Ç‡πâ‡∏≤)
            this.state.streak = (this.state.streak || 0) + 1;
        } else if (diffDays > 1) {
            // ‡∏Ç‡∏≤‡∏î‡∏ä‡πà‡∏ß‡∏á‡πÑ‡∏õ (Missed days) -> ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Streak Freeze
            const freezeCount = this.state.consumables['item_streak_freeze'] || 0;
            
            if (freezeCount > 0) {
                // ‡πÉ‡∏ä‡πâ‡πÑ‡∏≠‡πÄ‡∏ó‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
                this.state.consumables['item_streak_freeze']--;
                // ‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏¥‡πà‡∏° Streak ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï (Maintain current streak)
                console.log("Streak Freeze used! Streak maintained at:", this.state.streak);
                // Optional: ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡πÑ‡∏≠‡πÄ‡∏ó‡∏° (‡∏≠‡∏≤‡∏à‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ Event Dispatch ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ UI library ‡πÉ‡∏ô‡∏ô‡∏µ‡πâ)
            } else {
                // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏≠‡πÄ‡∏ó‡∏° -> ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï Streak
                this.state.streak = 1;
            }
        } else {
            // ‡∏Å‡∏£‡∏ì‡∏µ‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡πÄ‡∏ä‡πà‡∏ô diffDays <= 0 ‡∏ã‡∏∂‡πà‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏ß‡∏£‡πÄ‡∏Å‡∏¥‡∏î ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡∏à‡∏£‡∏¥‡∏á‡πÜ)
            this.state.streak = 1;
        }
        
        this.state.lastLogin = todayStr;
        this.updateLevel(); // Check if streak quest completion triggers level up
        this.saveState();
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏° XP (‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ó‡∏≥‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à)
    // OPTIMIZATION: Added options parameter to control saving.
    // This prevents redundant saves when called from a larger transaction like submitQuizResult.
    addXP(amount, category = '', options = { shouldSave: true }) {
        this.state.xp += amount;

        const track = this.identifyTrack(category);
        
        if (track === 'astronomy') {
            this.state.astronomyTrackXP = (this.state.astronomyTrackXP || 0) + amount;
        } else if (track === 'earth') {
            this.state.earthTrackXP = (this.state.earthTrackXP || 0) + amount;
        } else {
            // XP ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô (‡πÄ‡∏ä‡πà‡∏ô ‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏ß‡∏™) ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ô‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô General XP
            this.state.generalXP = (this.state.generalXP || 0) + amount;
        }

        this.updateLevel();

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Badge ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö XP ‡∏™‡∏∞‡∏™‡∏° (‡∏™‡πà‡∏á 0 ‡πÑ‡∏õ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö)
        this.checkBadges(0, 0, false);
        
        // Save state only if explicitly told to.
        if (options.shouldSave) {
            this.saveState();
        }
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡πÇ‡∏î‡∏¢‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤ XP ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏™‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤
    // ‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà quiz-logic.js ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö
    // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á XP, ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠, ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å Badge/Achievement ‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
    submitQuizResult(totalXP, percentage, questionCount, isCustomQuiz, topicXPs = {}, questStats = {}) {
        const oldLevelInfo = this.getCurrentLevel();
        const oldAstronomy = this.getAstronomyTrackLevel();
        const oldEarth = this.getEarthLevel();

        let newAstronomyTrackXP = 0;
        let newEarthTrackXP = 0;

        // Calculate track XP from the detailed topicXPs
        for (const [groupKey, groupDef] of Object.entries(PROFICIENCY_GROUPS)) {
            const xpForTopic = topicXPs[groupDef.field] || 0;
            if (groupDef.track === 'astronomy') {
                newAstronomyTrackXP += xpForTopic;
            } else if (groupDef.track === 'earth') {
                newEarthTrackXP += xpForTopic;
            }
        }

        // FIX: Fallback logic if topicXPs didn't capture the category (e.g. keywords mismatch)
        // This ensures XP is assigned to the correct track based on Quiz Category/ID
        let remainingXP = totalXP - newAstronomyTrackXP - newEarthTrackXP;
        if (remainingXP > 0) {
             const track = this.identifyTrack(questStats.category, questStats.quizId);
             
             if (track === 'astronomy') {
                 newAstronomyTrackXP += remainingXP;
                 remainingXP = 0;
             } else if (track === 'earth') {
                 newEarthTrackXP += remainingXP;
                 remainingXP = 0;
             }
        }

        this.state.xp += totalXP;
        this.state.astronomyTrackXP = (this.state.astronomyTrackXP || 0) + newAstronomyTrackXP;
        this.state.earthTrackXP = (this.state.earthTrackXP || 0) + newEarthTrackXP;
        this.state.generalXP = (this.state.generalXP || 0) + remainingXP;
        this.state.quizzesCompleted += 1;

        // --- NEW: Bonus XP for every 20 questions answered ---
        const qCount = questionCount || 0;
        this.state.accumulatedQuestionsForBonus = (this.state.accumulatedQuestionsForBonus || 0) + qCount;
        const bonusStep = 20;
        const bonusXPPerStep = 20; // ‡πÅ‡∏à‡∏Å 20 XP ‡∏ó‡∏∏‡∏Å‡πÜ 20 ‡∏Ç‡πâ‡∏≠

        const stepsCompleted = Math.floor(this.state.accumulatedQuestionsForBonus / bonusStep);

        if (stepsCompleted > 0) {
            const bonusXP = stepsCompleted * bonusXPPerStep;
            this.state.accumulatedQuestionsForBonus %= bonusStep; // ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏®‡∏©‡πÑ‡∏ß‡πâ‡∏£‡∏≠‡∏ö‡∏´‡∏ô‡πâ‡∏≤

            this.state.xp += bonusXP;
            this.state.generalXP = (this.state.generalXP || 0) + bonusXP;

            setTimeout(() => {
                showToast('‡πÇ‡∏ö‡∏ô‡∏±‡∏™‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏¢‡∏±‡∏ô! üî•', `‡∏™‡∏∞‡∏™‡∏°‡∏Ñ‡∏£‡∏ö ${stepsCompleted * bonusStep} ‡∏Ç‡πâ‡∏≠ ‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏° ${bonusXP} XP`, 'üéÅ');
            }, 1500);
        }
        // -----------------------------------------------------

        // Update Topic XPs
        for (const [field, xp] of Object.entries(topicXPs)) {
            if (this.state[field] === undefined) this.state[field] = 0;
            this.state[field] += xp;
        }

        // NEW: Check for weekend quiz completion
        const day = new Date().getDay(); // 0 = Sunday, 6 = Saturday
        if (day === 0 || day === 6) {
            this.state.weekendQuizzesCompleted = (this.state.weekendQuizzesCompleted || 0) + 1;
        }
        
        // NEW: Call the stats update function here
        this.updateEndQuizStats(percentage, questionCount, isCustomQuiz);

        this.updateLevel();

        // Check for new badges and achievements.
        // OPTIMIZATION: checkBadges no longer saves state internally.
        const newBadges = this.checkBadges(percentage, questionCount, isCustomQuiz);
        const newAchievements = this.checkAchievements();
        const questResult = this.updateQuest(questStats);
        
        // NEW: Save state ONCE at the end of all calculations
        this.saveState();
        
        // FIX: Update timestamp for charts in profile.js to detect changes
        localStorage.setItem('last_quiz_completed_timestamp', Date.now().toString());

        const newLevelInfo = this.getCurrentLevel();
        const newAstronomy = this.getAstronomyTrackLevel();
        const newEarth = this.getEarthLevel();

        return {
            overall: { leveledUp: newLevelInfo.level > oldLevelInfo.level, info: newLevelInfo },
            astronomy: { leveledUp: newAstronomy.level > oldAstronomy.level, info: newAstronomy },
            earth: { leveledUp: newEarth.level > oldEarth.level, info: newEarth },
            newBadges: newBadges,
            newAchievements: newAchievements
        };
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à
    // Logic: ‡∏£‡∏±‡∏ö stats ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö ‡πÅ‡∏•‡πâ‡∏ß‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏±‡∏ö Active Quests ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
    updateQuest(stats) {
        if (!this.state.activeQuests) return { completed: [], newAchievements: [] };

        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏ß‡∏° (Total Stats)
        if (stats.correctAnswers) {
            this.state.totalCorrectAnswers += stats.correctAnswers;
        }

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (Achievements) ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
        const newAchievements = this.checkAchievements();
        
        const completedQuests = [];

        // NEW: Check eligibility for quests that depend on score
        const isEligibleForStats = !stats.isCustomQuiz || (stats.isCustomQuiz && stats.questionCount >= 20);

        this.state.activeQuests.forEach(q => {
            if (q.completed) return;

            let progressMade = 0;

            if (q.type === 'quiz_complete') {
                progressMade = 1;
            } else if (q.type === 'correct_answers') {
                progressMade = stats.correctAnswers || 0;
            } else if (q.type === 'questions_category') {
                if (this.checkCategoryMatch(stats.category, q.category, stats.quizId)) {
                    progressMade = stats.totalQuestions || 0;
                }
            } else if (q.type === 'high_score') {
                if (isEligibleForStats) {
                    const threshold = q.threshold || 80;
                    if (stats.percentage >= threshold) progressMade = 1;
                }
            } else if (q.type === 'correct_answers_type') {
                if (q.questionType === 'theory') {
                    progressMade = stats.correctTheory || 0;
                } else if (q.questionType === 'calculation') {
                    progressMade = stats.correctCalculation || 0;
                }
            } else if (q.type === 'quiz_category') {
                if (this.checkCategoryMatch(stats.category, q.category, stats.quizId)) {
                    progressMade = 1;
                }
            }

            if (progressMade > 0) {
                q.progress += progressMade;
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ó‡∏≥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                if (q.progress >= q.target) {
                    q.progress = q.target;
                    q.completed = true;
                    // Use the quest's category for XP, fallback to 'General'
                    // OPTIMIZATION: Tell addXP not to save state, as submitQuizResult will handle it.
                    this.addXP(q.xp, q.category || 'General', { shouldSave: false });
                    completedQuests.push({ completed: true, quest: q });

                    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (History)
                    this.state.questHistory.unshift({
                        id: q.id,
                        desc: q.desc,
                        date: new Date().toLocaleDateString('th-TH'),
                        xp: q.xp
                    });
                    // ‡πÄ‡∏Å‡πá‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î 50 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                    if (this.state.questHistory.length > 50) this.state.questHistory.pop();
                }
            }
        });
        
        const leveledUp = this.updateLevel();

        // ‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÉ‡∏´‡∏°‡πà
        // No saveState() here, it will be called by the parent function (submitQuizResult)
        
        // ‡∏™‡πà‡∏á‡∏Ñ‡∏∑‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÉ‡∏´‡∏°‡πà
        return { completed: completedQuests, newAchievements };
    }

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏£‡∏∞‡∏¢‡∏∞‡∏¢‡∏≤‡∏ß (Achievements) ‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏•‡πÄ‡∏ß‡∏• 20, ‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏£‡∏ö 1000 ‡∏Ç‡πâ‡∏≠
    checkAchievements() {
        const newUnlocks = [];
        ACHIEVEMENTS.forEach(ach => {
            if (this.state.unlockedAchievements.includes(ach.id)) return;

            let achieved = false;
            if (ach.type === 'level') {
                if (this.getCurrentLevel().level >= ach.target) achieved = true;
            } else if (ach.type === 'total_correct') {
                if (this.state.totalCorrectAnswers >= ach.target) achieved = true;
            } else if (ach.type === 'total_quizzes') {
                if (this.state.quizzesCompleted >= ach.target) achieved = true;
            }
            // New Achievement Types
            else if (ach.type === 'high_scores_80') {
                if ((this.state.highScores80 || 0) >= ach.target) achieved = true;
            }
            else if (ach.type === 'perfect_scores') {
                if ((this.state.perfectScores || 0) >= ach.target) achieved = true;
            }
            else if (ach.type === 'total_items') {
                if (this.state.inventory.length >= ach.target) achieved = true;
            } else if (ach.type === 'total_avatars') {
                const avatarCount = this.state.inventory.filter(id => {
                    const item = SHOP_ITEMS.find(i => i.id === id);
                    return item && item.type === 'avatar';
                }).length;
                if (avatarCount >= ach.target) achieved = true;
            }

            if (achieved) {
                this.state.unlockedAchievements.push(ach.id);
                newUnlocks.push(ach);

                // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (History) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏ß‡πà‡∏≤‡∏ó‡∏≥‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß
                this.state.questHistory.unshift({
                    id: ach.id,
                    desc: `‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${ach.title}`,
                    date: new Date().toLocaleDateString('th-TH'),
                    xp: 0
                });
                if (this.state.questHistory.length > 50) this.state.questHistory.pop();
            }
        });
        return newUnlocks;
    }

    // Helper function to identify track from category/quizId
    identifyTrack(category, quizId = '') {
        const catString = (typeof category === 'string') ? category : (category?.main || String(category || ''));
        const lowerCat = catString.toLowerCase();
        const lowerId = String(quizId).toLowerCase();

        // Astronomy / Physics Track
        if (lowerCat.includes('astronomy') || lowerCat.includes('‡∏î‡∏≤‡∏£‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå') || 
            lowerCat.includes('space') || lowerCat.includes('‡∏≠‡∏ß‡∏Å‡∏≤‡∏®') || 
            lowerCat.includes('physics') || lowerCat.includes('‡∏ü‡∏¥‡∏™‡∏¥‡∏Å‡∏™‡πå') ||
            lowerId.includes('astro') || lowerId.startsWith('junior') || lowerId.startsWith('senior') || lowerId.includes('phy_')) {
            return 'astronomy';
        }

        // Earth Science / Geology / Meteorology Track
        if (lowerCat.includes('earth') || lowerCat.includes('‡πÇ‡∏•‡∏Å') || lowerCat.includes('‡∏ß‡∏¥‡∏ó‡∏¢‡πå‡πÇ‡∏•‡∏Å') || 
            lowerCat.includes('geology') || lowerCat.includes('‡∏ò‡∏£‡∏ì‡∏µ') || 
            lowerCat.includes('meteorology') || lowerCat.includes('‡∏≠‡∏∏‡∏ï‡∏∏‡∏ô‡∏¥‡∏¢‡∏°‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤') || 
            lowerCat.includes('oceanography') || lowerCat.includes('‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå') ||
            lowerId.startsWith('es') || lowerId.includes('earth') || lowerId.includes('ess_')) {
            return 'earth';
        }

        return 'general';
    }

    checkCategoryMatch(quizCat, questCat, quizId = '') {
        if (!quizCat && !quizId) return false;

        const lowerQuestCat = questCat.toLowerCase();

        if (lowerQuestCat === 'astronomy') {
            // Prevent Earth Science Review (ESr) from matching Astronomy quests
            if (String(quizId).toLowerCase().startsWith('es')) return false;
            return this.identifyTrack(quizCat, quizId) === 'astronomy';
        }
        if (lowerQuestCat === 'earth') {
            return this.identifyTrack(quizCat, quizId) === 'earth';
        }
        if (lowerQuestCat === 'review') {
            const catString = (typeof quizCat === 'string') ? quizCat : (quizCat?.main || String(quizCat || ''));
            const lowerQuizCat = catString.toLowerCase();
            const lowerQuizId = String(quizId).toLowerCase();
            return lowerQuizCat.includes('review') || lowerQuizCat.includes('‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô') || lowerQuizId.startsWith('esr') || (lowerQuizId.startsWith('astro') && !lowerQuizId.includes('posn'));
        }
        return false;
    }

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å Badge
    // Logic: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡πÅ‡∏•‡∏∞‡∏°‡∏≠‡∏ö‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏£‡∏≤‡∏á‡∏ß‡∏±‡∏•‡∏´‡∏≤‡∏Å‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö
    checkBadges(lastQuizScorePercent, questionCount = 0, isCustomQuiz = false) {
        const newBadges = [];

        const unlock = (badgeId) => {
            if (!this.state.badges.includes(badgeId)) {
                this.state.badges.push(badgeId);
                newBadges.push(BADGES.find(b => b.id === badgeId));
            }
        };

        const isEligibleForStats = !isCustomQuiz || (isCustomQuiz && questionCount >= 20);

        if (this.state.quizzesCompleted >= 1) unlock('first_quiz');

        if (isEligibleForStats) {
            if (lastQuizScorePercent === 100) unlock('perfect_score');
        }
        
        if ((this.state.highScores80 || 0) >= 3) unlock('high_scorer_3');
        if ((this.state.highScores80 || 0) >= 5) unlock('high_scorer_5');
        if ((this.state.highScores80 || 0) >= 10) unlock('high_scorer_10');
        
        if ((this.state.perfectScores || 0) >= 3) unlock('perfect_scorer_3');
        if ((this.state.perfectScores || 0) >= 5) unlock('perfect_scorer_5');

        if (questionCount >= 50) unlock('marathon_runner');

        if (this.state.quizzesCompleted >= 5) unlock('quiz_master_5');
        if (this.state.quizzesCompleted >= 10) unlock('quiz_master_10');
        if (this.state.quizzesCompleted >= 25) unlock('quiz_master_25');
        if (this.state.quizzesCompleted >= 50) unlock('quiz_master_50');
        if (this.state.quizzesCompleted >= 100) unlock('quiz_master_100');

        if (this.state.streak >= 3) unlock('streak_3');
        if (this.state.streak >= 7) unlock('streak_7');
        if (this.state.streak >= 14) unlock('streak_14');
        if (this.state.streak >= 30) unlock('streak_30');
        if (this.state.streak >= 60) unlock('streak_60');

        if (this.getAstronomyTrackLevel().level >= 3) unlock('astro_lover');
        if (this.getAstronomyTrackLevel().level >= 5) unlock('astro_expert');
        if (this.getAstronomyTrackLevel().level >= 10) unlock('astro_master');
        if (this.getEarthLevel().level >= 3) unlock('earth_lover');
        if (this.getEarthLevel().level >= 5) unlock('earth_expert');
        if (this.getEarthLevel().level >= 10) unlock('earth_master');
        if (this.state.xp >= 5000) unlock('xp_5k');
        if (this.state.xp >= 10000) unlock('xp_10k');
        
        if (this.getAstronomyTrackLevel().level >= 5 && this.getEarthLevel().level >= 5) unlock('dual_expert');

        if ((this.state.weekendQuizzesCompleted || 0) >= 3) unlock('weekend_learner_3');
        if ((this.state.weekendQuizzesCompleted || 0) >= 5) unlock('weekend_learner_5');
        if ((this.state.weekendQuizzesCompleted || 0) >= 10) unlock('weekend_learner_10');
        if ((this.state.weekendQuizzesCompleted || 0) >= 15) unlock('weekend_learner_15');

        if ((this.state.astronomyXP || 0) >= 1000) unlock('astronomy_expert');
        if ((this.state.geologyXP || 0) >= 1000) unlock('geology_expert');
        if ((this.state.meteorologyXP || 0) >= 1000) unlock('meteorology_expert');
        if ((this.state.oceanographyXP || 0) >= 1000) unlock('oceanography_expert');

        return newBadges;
    }

    getEarnedBadges() {
        return BADGES.filter(b => this.state.badges.includes(b.id));
    }

    getUnlockedAchievements() {
        return ACHIEVEMENTS.filter(a => this.state.unlockedAchievements.includes(a.id));
    }

    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì % ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÄ‡∏•‡πÄ‡∏ß‡∏•‡∏ñ‡∏±‡∏î‡πÑ‡∏õ
    getLevelProgressPercent() {
        return this.getCurrentLevel().progressPercent;
    }
}